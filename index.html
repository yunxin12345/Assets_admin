<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>企業資產管理系統 - Pro (CSV / 搜尋下拉)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }

    .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

    @media print {
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      body { background: white !important; }
      .preview-paper {
        box-shadow: none !important;
        margin: 0 !important;
        width: 100% !important;
        padding: 15mm !important;
        border: none !important;
      }
    }

    .preview-paper {
      background: white;
      width: 210mm;
      min-height: 297mm;
      padding: 20mm;
      margin: 20px auto;
      box-shadow: 0 20px 50px rgba(0,0,0,0.15);
      color: #1e293b;
      border: 1px solid #e2e8f0;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      font-weight: 800;
      border-bottom: 2px solid #334155;
      padding-bottom: 6px;
      margin-bottom: 16px;
    }

    .asset-table { width: 100%; border-collapse: collapse; }
    .asset-table th {
      background: #f8fafc;
      border: 1px solid #cbd5e1;
      padding: 12px;
      font-size: 13px;
      text-align: left;
    }
    .asset-table td {
      border: 1px solid #cbd5e1;
      padding: 12px;
      font-size: 14px;
    }

    /* Searchable dropdown */
    .ss-wrap { position: relative; }
    .ss-panel {
      position: absolute;
      z-index: 60;
      top: calc(100% + 8px);
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.12);
      overflow: hidden;
    }
    .ss-item:hover { background: #f1f5f9; }
    .ss-item.active { background: #eef2ff; color: #4338ca; }
  </style>
</head>

<body class="text-slate-900">

  <!-- Top Nav -->
  <nav class="bg-white border-b border-slate-200 sticky top-0 z-40 no-print">
    <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
      <div class="flex items-center gap-6">
        <div class="flex items-center gap-3">
          <div class="bg-indigo-600 p-2 rounded-xl text-white">
            <i data-lucide="shield-check" class="w-5 h-5"></i>
          </div>
          <h1 class="text-xl font-black text-slate-800">資產管理系統</h1>
        </div>

        <div class="flex bg-slate-100 p-1 rounded-xl">
          <button id="tab-assets" class="px-5 py-1.5 rounded-lg text-sm font-bold transition-all bg-white shadow-sm text-indigo-600">資產清冊</button>
          <button id="tab-staff" class="px-5 py-1.5 rounded-lg text-sm font-bold transition-all text-slate-500 hover:text-slate-700">員工管理</button>
        </div>
      </div>

      <div class="flex gap-3">
        <button onclick="openPrintModal()"
                class="px-4 py-2 bg-emerald-50 text-emerald-700 border border-emerald-200 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-emerald-100 transition-colors">
          <i data-lucide="file-text" class="w-4 h-4"></i> 生成領用單
        </button>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto p-6 no-print">

    <!-- Assets Section -->
    <section id="section-assets" class="space-y-4">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div class="space-y-2">
          <h2 class="text-2xl font-black">資產清冊</h2>
          <div class="flex gap-2 flex-wrap items-center">
            <button onclick="exportAssetsCSV()" class="px-3 py-1.5 bg-white border border-slate-200 rounded-xl text-xs font-bold text-slate-600 hover:bg-slate-50 flex items-center gap-2">
              <i data-lucide="download" class="w-4 h-4"></i> 匯出 CSV
            </button>
            <button onclick="triggerImport('assets')" class="px-3 py-1.5 bg-white border border-slate-200 rounded-xl text-xs font-bold text-slate-600 hover:bg-slate-50 flex items-center gap-2">
              <i data-lucide="upload" class="w-4 h-4"></i> 匯入 CSV
            </button>

            <!-- ✅ 品項篩選 -->
            <div class="relative">
              <button onclick="toggleItemFilterMenu()"
                      class="px-3 py-1.5 bg-white border border-slate-200 rounded-xl text-xs font-bold text-slate-600 hover:bg-slate-50 flex items-center gap-2">
                <i data-lucide="list-filter" class="w-4 h-4"></i>
                品項篩選：<span id="assets-item-filter-label">全部</span>
                <i data-lucide="chevron-down" class="w-4 h-4"></i>
              </button>
              <div id="assets-item-filter-menu" class="hidden absolute top-full left-0 mt-2 w-72 bg-white shadow-xl border border-slate-100 rounded-xl p-2 z-50">
                <!-- filled by JS -->
              </div>
            </div>
          </div>
        </div>

        <div class="flex gap-2 items-center">
          <div class="relative">
            <i data-lucide="search" class="w-4 h-4 absolute left-3 top-3 text-slate-400"></i>
            <input type="text" id="asset-search" placeholder="搜尋設備名稱或編號..."
                   class="pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-sm w-64 focus:ring-2 focus:ring-indigo-500 outline-none">
          </div>

          <!-- ✅ 資產批次刪除 -->
          <button onclick="bulkDeleteAssets()"
                  class="px-4 py-2 bg-red-50 text-red-600 border border-red-200 rounded-xl text-sm font-black flex items-center gap-2 hover:bg-red-100 transition-colors">
            <i data-lucide="trash-2" class="w-4 h-4"></i> 批次刪除
          </button>

          <button onclick="showAddAssetModal()"
                  class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-sm font-black flex items-center gap-2 shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all">
            <i data-lucide="plus" class="w-4 h-4"></i> 新增資產
          </button>
        </div>
      </div>

      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden overflow-x-auto">
        <table class="w-full text-left">
          <thead class="bg-slate-50 border-b border-slate-200 text-[11px] font-black text-slate-400 uppercase tracking-wider">
            <tr>
              <!-- ✅ 勾選全選：只針對目前篩選後 -->
              <th class="p-4 w-12">
                <input type="checkbox" id="asset-check-all" class="w-5 h-5 accent-indigo-600"
                       onclick="toggleAssetCheckAll(this.checked)">
              </th>

              <th class="p-4 w-[160px]">資產編號</th>

              <th class="p-4">
                <div class="flex items-center justify-between gap-2">
                  <button class="flex items-center gap-1 font-black text-slate-500 hover:text-slate-700"
                          onclick="toggleSort('name')">
                    設備名稱
                    <span id="sort-icon-name"><i data-lucide="chevrons-up-down" class="w-3 h-3 text-slate-300"></i></span>
                  </button>

                  <div class="relative">
                    <button onclick="event.stopPropagation(); toggleAssignedFilterMenu()"
                            class="p-2 hover:bg-slate-200 rounded-lg">
                      <i data-lucide="filter" class="w-4 h-4 text-slate-400 hover:text-indigo-500"></i>
                    </button>
                    <div id="assigned-filter-menu" class="hidden absolute top-full right-0 mt-2 w-56 bg-white shadow-xl border border-slate-100 rounded-xl p-2 z-50 normal-case">
                      <button onclick="setAssignedFilter('all')" class="w-full text-left px-3 py-2 hover:bg-slate-50 text-xs text-slate-700 rounded-lg">全部</button>
                      <button onclick="setAssignedFilter('assigned')" class="w-full text-left px-3 py-2 hover:bg-slate-50 text-xs text-slate-700 rounded-lg">已分配</button>
                      <button onclick="setAssignedFilter('unassigned')" class="w-full text-left px-3 py-2 hover:bg-slate-50 text-xs text-slate-700 rounded-lg">待分配</button>
                    </div>
                  </div>
                </div>
              </th>

              <th class="p-4">保管人</th>
              <th class="p-4">部門</th>
              <th class="p-4">規格</th>
              <th class="p-4 text-right">操作</th>
            </tr>
          </thead>

          <tbody id="asset-list" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>
    </section>


    <!-- Staff Section -->
    <section id="section-staff" class="hidden space-y-4">

      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div class="space-y-2">
          <h2 class="text-2xl font-black">員工管理</h2>

          <div class="flex gap-2 flex-wrap items-center">
            <button onclick="exportStaffCSV()" class="px-3 py-1.5 bg-white border border-slate-200 rounded-xl text-xs font-bold text-slate-600 hover:bg-slate-50 flex items-center gap-2">
              <i data-lucide="download" class="w-4 h-4"></i> 匯出 CSV
            </button>
            <button onclick="triggerImport('staff')" class="px-3 py-1.5 bg-white border border-slate-200 rounded-xl text-xs font-bold text-slate-600 hover:bg-slate-50 flex items-center gap-2">
              <i data-lucide="upload" class="w-4 h-4"></i> 匯入 CSV
            </button>

            <div class="relative">
              <button onclick="toggleDeptFilterMenu('staff')"
                      class="px-3 py-1.5 bg-white border border-slate-200 rounded-xl text-xs font-bold text-slate-600 hover:bg-slate-50 flex items-center gap-2">
                <i data-lucide="building-2" class="w-4 h-4"></i> 部門篩選：<span id="staff-dept-filter-label">全部</span>
                <i data-lucide="chevron-down" class="w-4 h-4"></i>
              </button>
              <div id="staff-dept-filter-menu" class="hidden absolute top-full left-0 mt-2 w-60 bg-white shadow-xl border border-slate-100 rounded-xl p-2 z-50">
                <!-- filled by JS -->
              </div>
            </div>
          </div>
        </div>

        <div class="flex gap-3 items-center">
          <button onclick="bulkDeleteStaff()"
                  class="px-4 py-2 bg-red-50 text-red-600 border border-red-200 rounded-xl text-sm font-black flex items-center gap-2 hover:bg-red-100 transition-colors">
            <i data-lucide="trash-2" class="w-4 h-4"></i> 批次刪除
          </button>

          <button onclick="showAddStaffModal()"
                  class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-sm font-black flex items-center gap-2 shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all">
            <i data-lucide="user-plus" class="w-4 h-4"></i> 新增員工
          </button>
        </div>
      </div>

      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
        <table class="w-full text-left">
          <thead class="bg-slate-50 border-b border-slate-200 text-[11px] font-black text-slate-400">
            <tr>
              <th class="p-4 w-12">
                <input type="checkbox" id="staff-check-all" class="w-5 h-5 accent-indigo-600" onclick="toggleStaffCheckAll(this.checked)">
              </th>
              <th class="p-4 w-32">員工編號</th>
              <th class="p-4">姓名</th>
              <th class="p-4">職稱</th>
              <th class="p-4">部門</th>
              <th class="p-4">到職日期</th>
              <th class="p-4 text-right">管理</th>
            </tr>
          </thead>
          <tbody id="staff-list" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>
    </section>

  </main>

  <!-- Hidden Import Inputs -->
  <input id="import-assets" type="file" accept=".csv" class="hidden" onchange="handleImportCSV('assets', this.files?.[0])">
  <input id="import-staff" type="file" accept=".csv" class="hidden" onchange="handleImportCSV('staff', this.files?.[0])">

  <!-- Modal -->
  <div id="modal-overlay" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto custom-scroll" id="modal-content"></div>
  </div>

  <!-- Preview -->
  <div id="preview-overlay" class="hidden fixed inset-0 bg-slate-900/90 z-[60] overflow-y-auto no-print">
    <div class="sticky top-0 bg-white border-b p-4 flex justify-between items-center shadow-lg">
      <button onclick="closePreview()" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
      <div class="flex gap-3">
        <button onclick="window.print()" class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-black flex items-center gap-2">
          <i data-lucide="printer" class="w-5 h-5"></i> 確認列印
        </button>
      </div>
    </div>
    <div id="preview-render" class="flex justify-center py-10"></div>
  </div>

  <div id="print-area" class="hidden print-only"></div>

  <script>
    /*****************************
     * Storage Keys
     *****************************/
    const LS_ASSETS = 'assets_pro_v4_csv';
    const LS_STAFF  = 'staff_pro_v4_csv';

    /*****************************
     * Data Init
     *****************************/
    let assets = JSON.parse(localStorage.getItem(LS_ASSETS)) || [];
    let staff  = JSON.parse(localStorage.getItem(LS_STAFF)) || [
      { id: "EMP001", name: "王大明", title: "工程師", dept: "技術部", joinDate: "2023-01-01" }
    ];

    /*****************************
     * UI State
     *****************************/
    let currentSort = { key: null, direction: 'asc' };
    let assignedFilter = 'all';          // all/assigned/unassigned
    let assetsItemFilter = '全部';       // ✅ 品項篩選：asset.name
    let staffDeptFilter  = '全部';       // staff dept filter
    let selectedStaffIds = new Set();    // bulk delete staff
    let selectedAssetIds = new Set();    // ✅ bulk delete assets
    let lastFilteredAssetIds = [];       // ✅ render 時記錄「目前篩選後」資產 ids（for check-all safety）

    /*****************************
     * Save / Helpers
     *****************************/
    function save() {
      localStorage.setItem(LS_ASSETS, JSON.stringify(assets));
      localStorage.setItem(LS_STAFF, JSON.stringify(staff));
      render();
    }

    function isURL(str) {
      try { const url = new URL(str); return url.protocol === "http:" || url.protocol === "https:"; }
      catch (_) { return false; }
    }
    function openLink(val) { if (isURL(val)) window.open(val, '_blank'); }

    function normalize(str) { return (str ?? '').toString().trim(); }

    function getStaffByName(name) {
      return staff.find(s => s.name === name) || null;
    }
    function getDeptSetFromStaff() {
      return new Set(staff.map(s => normalize(s.dept)).filter(Boolean));
    }
    function getDeptSetFromAssets() {
      return new Set(assets.map(a => normalize(a.dept)).filter(Boolean));
    }
    function getItemSetFromAssets() {
      // ✅ 品項 = 設備名稱(name)
      return new Set(assets.map(a => normalize(a.name)).filter(Boolean));
    }

    /*****************************
     * Tabs
     *****************************/
    document.getElementById('tab-assets').onclick = () => switchTab('assets');
    document.getElementById('tab-staff').onclick  = () => switchTab('staff');

    function switchTab(type) {
      const isAssets = type === 'assets';
      document.getElementById('section-assets').classList.toggle('hidden', !isAssets);
      document.getElementById('section-staff').classList.toggle('hidden', isAssets);

      document.getElementById('tab-assets').className = isAssets
        ? "px-5 py-1.5 rounded-lg text-sm font-bold bg-white shadow-sm text-indigo-600"
        : "px-5 py-1.5 rounded-lg text-sm font-bold text-slate-500 hover:text-slate-700";

      document.getElementById('tab-staff').className = !isAssets
        ? "px-5 py-1.5 rounded-lg text-sm font-bold bg-white shadow-sm text-indigo-600"
        : "px-5 py-1.5 rounded-lg text-sm font-bold text-slate-500 hover:text-slate-700";
    }

    document.getElementById('asset-search').oninput = render;

    /*****************************
     * Filters & Sorting
     *****************************/
    function toggleSort(key) {
      if (currentSort.key === key) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.key = key;
        currentSort.direction = 'asc';
      }
      render();
    }

    function toggleAssignedFilterMenu() {
      document.getElementById('assigned-filter-menu').classList.toggle('hidden');
    }
    function setAssignedFilter(v) {
      assignedFilter = v;
      document.getElementById('assigned-filter-menu').classList.add('hidden');
      render();
    }

    function toggleDeptFilterMenu(kind) {
      const menuId = (kind === 'staff') ? 'staff-dept-filter-menu' : 'assets-dept-filter-menu';
      const menu = document.getElementById(menuId);
      if (menu) menu.classList.toggle('hidden');
    }

    function setDeptFilter(kind, dept) {
      if (kind === 'staff') {
        staffDeptFilter = dept;
        document.getElementById('staff-dept-filter-label').textContent = dept;
        document.getElementById('staff-dept-filter-menu').classList.add('hidden');
      }
      render();
    }

    // ✅ 品項篩選
    function toggleItemFilterMenu() {
      document.getElementById('assets-item-filter-menu').classList.toggle('hidden');
    }
    function setItemFilter(item) {
      assetsItemFilter = item;
      document.getElementById('assets-item-filter-label').textContent = item;
      document.getElementById('assets-item-filter-menu').classList.add('hidden');
      render();
    }

    function buildDeptMenus() {
      // staff dept menu（保留）
      const staffMenu = document.getElementById('staff-dept-filter-menu');
      if (staffMenu) {
        const staffDepts = ['全部', ...Array.from(getDeptSetFromStaff()).sort((a,b)=>a.localeCompare(b,'zh-Hant'))];
        staffMenu.innerHTML = staffDepts.map(d => `
          <button onclick="setDeptFilter('staff','${escapeHtmlAttr(d)}')"
                  class="w-full text-left px-3 py-2 hover:bg-slate-50 text-xs text-slate-700 rounded-lg">
            ${d}
          </button>
        `).join('');
      }

      // ✅ assets item menu（品項）
      const itemMenu = document.getElementById('assets-item-filter-menu');
      if (itemMenu) {
        const items = ['全部', ...Array.from(getItemSetFromAssets()).sort((a,b)=>a.localeCompare(b,'zh-Hant'))];
        itemMenu.innerHTML = items.map(it => `
          <button onclick="setItemFilter('${escapeHtmlAttr(it)}')"
                  class="w-full text-left px-3 py-2 hover:bg-slate-50 text-xs text-slate-700 rounded-lg">
            ${it}
          </button>
        `).join('');
      }
    }

    /*****************************
     * Render
     *****************************/
    function render() {
      buildDeptMenus();

      // Assets
      const searchTerm = document.getElementById('asset-search').value.toLowerCase();

      let filteredAssets = assets.filter(a => {
        const matchSearch =
          (a.name||'').toLowerCase().includes(searchTerm) ||
          (a.id||'').toLowerCase().includes(searchTerm);
        if (!matchSearch) return false;

        if (assignedFilter === 'assigned' && !a.user) return false;
        if (assignedFilter === 'unassigned' && a.user) return false;

        // ✅ 品項篩選（a.name）
        if (assetsItemFilter !== '全部') {
          const item = normalize(a.name);
          if (item !== assetsItemFilter) return false;
        }

        return true;
      });

      if (currentSort.key) {
        filteredAssets.sort((a,b) => {
          const va = (a[currentSort.key] || '').toString();
          const vb = (b[currentSort.key] || '').toString();
          return currentSort.direction === 'asc'
            ? va.localeCompare(vb, 'zh-Hant')
            : vb.localeCompare(va, 'zh-Hant');
        });
      }

      // ✅ 保存目前篩選後 id（for 全選/批刪安全）
      lastFilteredAssetIds = filteredAssets.map(a => a.id);
      syncAssetCheckAll();

      const sortIcon = document.getElementById('sort-icon-name');
      if (currentSort.key === 'name') {
        sortIcon.innerHTML = currentSort.direction === 'asc'
          ? '<i data-lucide="chevron-up" class="w-3 h-3 text-indigo-600"></i>'
          : '<i data-lucide="chevron-down" class="w-3 h-3 text-indigo-600"></i>';
      } else {
        sortIcon.innerHTML = '<i data-lucide="chevrons-up-down" class="w-3 h-3 text-slate-300"></i>';
      }

      const assetList = document.getElementById('asset-list');
      assetList.innerHTML = filteredAssets.map(a => `
        <tr class="hover:bg-slate-50 cursor-pointer transition-colors" onclick="showAssetDetail('${escapeHtmlAttr(a.id)}')">
          <td class="p-4" onclick="event.stopPropagation()">
            <input type="checkbox" class="w-5 h-5 accent-indigo-600"
                   ${selectedAssetIds.has(a.id) ? 'checked' : ''}
                   onclick="toggleAssetSelect('${escapeHtmlAttr(a.id)}', this.checked)">
          </td>

          <td class="p-4 font-mono text-xs font-bold text-indigo-600">${escapeHtml(a.id)}</td>
          <td class="p-4 font-bold text-slate-700">${escapeHtml(a.name)}</td>
          <td class="p-4">${a.user ? escapeHtml(a.user) : '<span class="text-slate-300">未分配</span>'}</td>
          <td class="p-4 text-slate-600 text-sm">${a.dept ? escapeHtml(a.dept) : '<span class="text-slate-300">--</span>'}</td>
          <td class="p-4 text-slate-500 text-sm truncate max-w-[240px]">${escapeHtml(a.spec || '')}</td>
          <td class="p-4 text-right">
            <button onclick="event.stopPropagation(); generatePrintByUser('${escapeHtmlAttr(a.user)}')"
                    class="text-indigo-600 hover:text-indigo-800 text-sm font-bold bg-indigo-50 px-3 py-1 rounded-lg">
              領用單
            </button>
          </td>
        </tr>
      `).join('');

      // Staff
      const staffList = document.getElementById('staff-list');
      const staffFiltered = staff.filter(s => (staffDeptFilter === '全部') ? true : (normalize(s.dept) === staffDeptFilter));

      staffList.innerHTML = staffFiltered.map(s => `
        <tr class="hover:bg-slate-50 transition-colors">
          <td class="p-4">
            <input type="checkbox" class="w-5 h-5 accent-indigo-600"
                   ${selectedStaffIds.has(s.id) ? 'checked' : ''}
                   onclick="toggleStaffSelect('${escapeHtmlAttr(s.id)}', this.checked)">
          </td>
          <td class="p-4 font-mono text-xs">${escapeHtml(s.id)}</td>
          <td class="p-4 font-black">${escapeHtml(s.name)}</td>
          <td class="p-4 text-slate-700">${escapeHtml(s.title || '')}</td>
          <td class="p-4 text-slate-700">${escapeHtml(s.dept || '')}</td>
          <td class="p-4 text-slate-500">${escapeHtml(s.joinDate || '')}</td>
          <td class="p-4 text-right">
            <button onclick="showStaffDetail('${escapeHtmlAttr(s.id)}')"
                    class="text-slate-500 hover:text-indigo-600 p-2 rounded-lg hover:bg-slate-100">
              <i data-lucide="edit-3" class="w-4 h-4"></i>
            </button>
          </td>
        </tr>
      `).join('');

      lucide.createIcons();
    }

    /*****************************
     * Bulk Select / Delete Assets ✅
     *****************************/
    function toggleAssetSelect(id, checked) {
      if (checked) selectedAssetIds.add(id);
      else selectedAssetIds.delete(id);
      syncAssetCheckAll();
    }

    function toggleAssetCheckAll(checked) {
      // ✅ 只對「目前篩選後」的資產做全選/全不選
      const ids = lastFilteredAssetIds || [];
      if (checked) ids.forEach(id => selectedAssetIds.add(id));
      else ids.forEach(id => selectedAssetIds.delete(id));
      render();
      syncAssetCheckAll();
    }

    function syncAssetCheckAll() {
      const ids = lastFilteredAssetIds || [];
      const allChecked = ids.length > 0 && ids.every(id => selectedAssetIds.has(id));
      const el = document.getElementById('asset-check-all');
      if (el) el.checked = allChecked;
    }

    function bulkDeleteAssets() {
      // ✅ 只刪除目前篩選後「有勾到」的
      const idsInView = new Set(lastFilteredAssetIds || []);
      const toDelete = Array.from(selectedAssetIds).filter(id => idsInView.has(id));

      if (toDelete.length === 0) return alert('請先勾選要刪除的資產（僅會刪除目前篩選後勾到的）');

      const msg =
        `確定刪除 ${toDelete.length} 項資產？\n` +
        `（只會刪除目前篩選後勾到的）\n` +
        `⚠️ 刪除後無法復原`;

      if (!confirm(msg)) return;

      const delSet = new Set(toDelete);
      assets = assets.filter(a => !delSet.has(a.id));

      // ✅ 刪完要清空，避免下次誤刪
      selectedAssetIds.clear();
      save();

      const el = document.getElementById('asset-check-all');
      if (el) el.checked = false;
    }

    /*****************************
     * Bulk Select / Delete Staff (原本)
     *****************************/
    function toggleStaffSelect(id, checked) {
      if (checked) selectedStaffIds.add(id);
      else selectedStaffIds.delete(id);
      syncStaffCheckAll();
    }

    function toggleStaffCheckAll(checked) {
      const staffFiltered = staff.filter(s => (staffDeptFilter === '全部') ? true : (normalize(s.dept) === staffDeptFilter));
      if (checked) staffFiltered.forEach(s => selectedStaffIds.add(s.id));
      else staffFiltered.forEach(s => selectedStaffIds.delete(s.id));
      render();
      syncStaffCheckAll();
    }

    function syncStaffCheckAll() {
      const staffFiltered = staff.filter(s => (staffDeptFilter === '全部') ? true : (normalize(s.dept) === staffDeptFilter));
      const allChecked = staffFiltered.length > 0 && staffFiltered.every(s => selectedStaffIds.has(s.id));
      document.getElementById('staff-check-all').checked = allChecked;
    }

    function bulkDeleteStaff() {
      if (selectedStaffIds.size === 0) return alert('請先勾選要刪除的員工');
      if (!confirm(`確定刪除 ${selectedStaffIds.size} 位員工？其名下資產將改為未分配。`)) return;

      const idsToDelete = new Set(selectedStaffIds);
      const namesToDelete = new Set(staff.filter(s => idsToDelete.has(s.id)).map(s => s.name));

      staff = staff.filter(s => !idsToDelete.has(s.id));

      assets.forEach(a => {
        if (namesToDelete.has(a.user)) {
          a.user = '';
          a.dept = '';
        }
      });

      selectedStaffIds.clear();
      save();
      document.getElementById('staff-check-all').checked = false;
    }

    /*****************************
     * Asset ID helper
     *****************************/
    function generateAssetID(name) {
      const isApple = /apple|mac|iphone|ipad|ipod/i.test(name);
      if (isApple) return ""; // Apple -> manual
      const prefix = (name || 'AS').substring(0, 2).toUpperCase().replace(/[^A-Z0-9]/g,'A');
      const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, "");
      const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
      return `${prefix}-${dateStr}-${random}`;
    }

    /*****************************
     * Modals: Asset
     *****************************/
    function showAddAssetModal() {
      openModal(`
        <div class="p-8">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-black">新增資產設備</h2>
            <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
          </div>

          <form onsubmit="handleAddAsset(event)" class="space-y-4">
            <div>
              <label class="text-sm font-bold mb-1 block">設備名稱</label>
              <input required name="name" id="new-asset-name" oninput="handleIDPreview(this.value)"
                     class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-indigo-500">
            </div>

            <div id="id-container">
              <label class="text-sm font-bold mb-1 block">資產編號</label>
              <input required name="id" id="new-asset-id"
                     class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-indigo-500">
              <p class="text-[11px] text-slate-400 mt-2">Apple 類型請手動輸入；非 Apple 會自動帶入建議編號</p>
            </div>

            <div>
              <label class="text-sm font-bold mb-1 block">規格描述</label>
              <input name="spec" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-indigo-500">
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-sm font-bold mb-1 block">購買日期</label>
                <input type="date" name="buyDate" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
              </div>
              <div>
                <label class="text-sm font-bold mb-1 block">領取日期</label>
                <input type="date" name="receiveDate" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
              </div>

              <div>
                <label class="text-sm font-bold mb-1 block">保固日期</label>
                <input type="date" name="warranty" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
              </div>
              <div>
                <label class="text-sm font-bold mb-1 block">購買金額</label>
                <input type="number" name="price" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
              </div>

              <div class="col-span-2">
                <label class="text-sm font-bold mb-1 block">保管人（員工）</label>
                <select name="user" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
                  <option value="">-- 未分配 --</option>
                  ${staff.map(s => `<option value="${escapeHtmlAttr(s.name)}">${escapeHtml(s.name)}</option>`).join('')}
                </select>
                <p class="text-[11px] text-slate-400 mt-2">選擇員工後會自動帶出部門（儲存時處理）</p>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-sm font-bold mb-1 block">收據明細 / 網址</label>
                <textarea name="receipt" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl h-20 text-sm" placeholder="輸入文字或 URL"></textarea>
              </div>
              <div>
                <label class="text-sm font-bold mb-1 block">保固書說明 / 網址</label>
                <textarea name="warrantyDoc" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl h-20 text-sm" placeholder="輸入文字或 URL"></textarea>
              </div>
            </div>

            <div class="flex gap-3 pt-4">
              <button type="button" onclick="closeModal()"
                      class="flex-1 py-4 bg-slate-100 text-slate-500 rounded-2xl font-bold">取消</button>
              <button type="submit"
                      class="flex-[2] py-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg shadow-indigo-100">確認新增</button>
            </div>
          </form>
        </div>
      `);
    }

    function handleIDPreview(val) {
      const idInput = document.getElementById('new-asset-id');
      const generated = generateAssetID(val);
      if (generated) {
        idInput.value = generated;
        idInput.classList.add('bg-slate-100');
      } else {
        idInput.value = "";
        idInput.classList.remove('bg-slate-100');
        idInput.placeholder = "請手動輸入 Apple 資產編號";
      }
    }

    function handleAddAsset(e) {
      e.preventDefault();
      const fd = new FormData(e.target);
      const id = normalize(fd.get('id'));
      if (assets.some(a => a.id === id)) return alert('資產編號重複！');

      const userName = normalize(fd.get('user'));
      const staffObj = userName ? getStaffByName(userName) : null;

      assets.push({
        id,
        name: normalize(fd.get('name')),
        spec: normalize(fd.get('spec')),
        buyDate: normalize(fd.get('buyDate')),
        receiveDate: normalize(fd.get('receiveDate')), // ✅ 領取日期
        warranty: normalize(fd.get('warranty')),
        price: normalize(fd.get('price')),
        user: userName,
        dept: staffObj ? staffObj.dept : '',
        receipt: normalize(fd.get('receipt')),
        warrantyDoc: normalize(fd.get('warrantyDoc')),
        history: [],
        repairs: []
      });

      save();
      closeModal();
    }

    function showAssetDetail(id) {
      const a = assets.find(x => x.id === id);
      if (!a) return;

      openModal(`
        <div class="p-8">
          <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-black">資產詳細資訊 / 編輯</h2>
            <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
          </div>

          <form onsubmit="handleUpdateAsset(event, '${escapeHtmlAttr(id)}')" class="space-y-6">
            <div class="grid grid-cols-2 gap-4">
              <div class="col-span-2 md:col-span-1">
                <label class="text-xs font-bold text-slate-400 mb-1 block">設備名稱</label>
                <input name="name" value="${escapeHtmlAttr(a.name)}"
                       class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold">
              </div>
              <div class="col-span-2 md:col-span-1">
                <label class="text-xs font-bold text-slate-400 mb-1 block">資產編號 (唯讀)</label>
                <input disabled value="${escapeHtmlAttr(a.id)}"
                       class="w-full p-3 bg-slate-100 border border-slate-200 rounded-xl font-mono text-indigo-600">
              </div>
            </div>

            <div>
              <label class="text-xs font-bold text-slate-400 mb-1 block">規格描述</label>
              <input name="spec" value="${escapeHtmlAttr(a.spec || '')}"
                     class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-xs font-bold text-slate-400 mb-1 block">保管人（員工）</label>
                <select name="user" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
                  <option value="">-- 未分配 --</option>
                  ${staff.map(s => `<option value="${escapeHtmlAttr(s.name)}" ${a.user === s.name ? 'selected' : ''}>${escapeHtml(s.name)}</option>`).join('')}
                </select>
              </div>
              <div>
                <label class="text-xs font-bold text-slate-400 mb-1 block">部門（自動帶出，唯讀）</label>
                <input disabled value="${escapeHtmlAttr(a.dept || '')}"
                       class="w-full p-3 bg-slate-100 border border-slate-200 rounded-xl">
              </div>

              <div>
                <label class="text-xs font-bold text-slate-400 mb-1 block">購買日期</label>
                <input type="date" name="buyDate" value="${escapeHtmlAttr(a.buyDate || '')}"
                       class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
              </div>
              <div>
                <label class="text-xs font-bold text-slate-400 mb-1 block">領取日期</label>
                <input type="date" name="receiveDate" value="${escapeHtmlAttr(a.receiveDate || '')}"
                       class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
              </div>

              <div>
                <label class="text-xs font-bold text-slate-400 mb-1 block">保固期至</label>
                <input type="date" name="warranty" value="${escapeHtmlAttr(a.warranty || '')}"
                       class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
              </div>
              <div>
                <label class="text-xs font-bold text-slate-400 mb-1 block">購買金額</label>
                <input type="number" name="price" value="${escapeHtmlAttr(a.price || '')}"
                       class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <div class="flex justify-between items-center mb-1">
                  <label class="text-xs font-bold text-slate-400">收據明細 / 雲端連結</label>
                  ${isURL(a.receipt) ? `<button type="button" onclick="openLink('${escapeHtmlAttr(a.receipt)}')" class="text-[10px] text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-md flex items-center gap-1">開啟連結 <i data-lucide="external-link" class="w-2.5 h-2.5"></i></button>` : ''}
                </div>
                <textarea name="receipt" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl h-20 text-sm"
                          placeholder="請輸入收據資訊或網址...">${escapeHtml(a.receipt || '')}</textarea>
              </div>

              <div>
                <div class="flex justify-between items-center mb-1">
                  <label class="text-xs font-bold text-slate-400">保固書說明 / 雲端連結</label>
                  ${isURL(a.warrantyDoc) ? `<button type="button" onclick="openLink('${escapeHtmlAttr(a.warrantyDoc)}')" class="text-[10px] text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-md flex items-center gap-1">開啟連結 <i data-lucide="external-link" class="w-2.5 h-2.5"></i></button>` : ''}
                </div>
                <textarea name="warrantyDoc" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl h-20 text-sm"
                          placeholder="請輸入保固資訊或網址...">${escapeHtml(a.warrantyDoc || '')}</textarea>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-8 mt-6 border-t pt-6">
              <div class="space-y-3">
                <div class="flex items-center gap-2 text-indigo-600">
                  <i data-lucide="history" class="w-4 h-4"></i>
                  <span class="text-sm font-bold">歷史領用紀錄</span>
                </div>
                <div class="max-h-32 overflow-y-auto bg-slate-50 rounded-xl p-3 text-xs space-y-2 border border-slate-100 custom-scroll">
                  ${(a.history && a.history.length) ? a.history.map(h => `
                    <div class="flex justify-between text-slate-500 border-b border-slate-200 pb-1">
                      <span class="font-bold">${escapeHtml(h.name)}</span>
                      <span>${escapeHtml(h.date)}</span>
                    </div>
                  `).join('') : '<p class="text-slate-300 italic">尚無前領用者資料</p>'}
                </div>
              </div>

              <div class="space-y-3">
                <div class="flex items-center gap-2 text-amber-600">
                  <i data-lucide="wrench" class="w-4 h-4"></i>
                  <span class="text-sm font-bold">維修紀錄</span>
                </div>
                <div class="max-h-32 overflow-y-auto bg-slate-50 rounded-xl p-3 text-xs space-y-2 border border-slate-100 custom-scroll">
                  ${(a.repairs && a.repairs.length) ? a.repairs.map(r => `
                    <div class="text-slate-600 border-b border-slate-200 pb-1">
                      <div class="flex justify-between font-bold"><span>${escapeHtml(r.date)}</span><span>${escapeHtml(r.status)}</span></div>
                      <div class="text-slate-400 mt-1">${escapeHtml(r.desc)}</div>
                    </div>
                  `).join('') : '<p class="text-slate-300 italic">尚無維修紀錄</p>'}
                </div>
                <button type="button" onclick="addRepairRecord('${escapeHtmlAttr(id)}')"
                        class="text-xs text-amber-700 font-bold hover:underline">+ 新增維修紀錄</button>
              </div>
            </div>

            <div class="flex gap-3 pt-6">
              <button type="button" onclick="deleteAsset('${escapeHtmlAttr(id)}')"
                      class="px-6 py-3 border border-red-100 text-red-500 rounded-xl font-bold hover:bg-red-50">刪除資產</button>
              <button type="submit"
                      class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-100">儲存變更</button>
            </div>
          </form>
        </div>
      `);

      lucide.createIcons();
    }

    function handleUpdateAsset(e, id) {
      e.preventDefault();
      const fd = new FormData(e.target);
      const index = assets.findIndex(x => x.id === id);
      if (index < 0) return;

      const asset = assets[index];
      const newUser = normalize(fd.get('user'));
      const staffObj = newUser ? getStaffByName(newUser) : null;

      if (newUser !== asset.user && asset.user) {
        if (!asset.history) asset.history = [];
        asset.history.unshift({ name: asset.user, date: new Date().toLocaleDateString() });
      }

      assets[index] = {
        ...asset,
        name: normalize(fd.get('name')),
        spec: normalize(fd.get('spec')),
        user: newUser,
        dept: staffObj ? staffObj.dept : '',
        buyDate: normalize(fd.get('buyDate')),
        receiveDate: normalize(fd.get('receiveDate')), // ✅ 領取日期
        price: normalize(fd.get('price')),
        warranty: normalize(fd.get('warranty')),
        receipt: normalize(fd.get('receipt')),
        warrantyDoc: normalize(fd.get('warrantyDoc'))
      };

      save();
      closeModal();
    }

    function addRepairRecord(id) {
      const desc = prompt("請輸入維修內容：");
      if (!desc) return;
      const index = assets.findIndex(x => x.id === id);
      if (index < 0) return;
      if (!assets[index].repairs) assets[index].repairs = [];
      assets[index].repairs.unshift({
        date: new Date().toLocaleDateString(),
        desc: desc,
        status: "已完成"
      });
      save();
      showAssetDetail(id);
    }

    function deleteAsset(id) {
      if (!confirm('確定刪除此資產？\n⚠️ 刪除後無法復原')) return;
      assets = assets.filter(a => a.id !== id);
      // 若刪的是已勾選的也要同步清掉
      selectedAssetIds.delete(id);
      save();
      closeModal();
    }

    /*****************************
     * Modals: Staff
     *****************************/
    function showAddStaffModal() {
      openModal(`
        <div class="p-8">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-black">新增員工</h2>
            <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
          </div>

          <form onsubmit="handleAddStaff(event)" class="space-y-4">
            <div>
              <label class="text-sm font-bold mb-1 block">員工編號</label>
              <input required name="id" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
            </div>

            <div>
              <label class="text-sm font-bold mb-1 block">姓名</label>
              <input required name="name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
            </div>

            <div>
              <label class="text-sm font-bold mb-1 block">職稱</label>
              <input name="title" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl" placeholder="例如：Senior Engineer / Admin / Manager...">
            </div>

            <div>
              <label class="text-sm font-bold mb-1 block">部門</label>
              <input required name="dept" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
            </div>

            <div>
              <label class="text-sm font-bold mb-1 block">到職日期</label>
              <input type="date" required name="joinDate" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
            </div>

            <div class="flex gap-3 pt-6">
              <button type="button" onclick="closeModal()"
                      class="flex-1 py-4 bg-slate-100 text-slate-500 rounded-2xl font-bold">取消</button>
              <button type="submit"
                      class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-bold">確認新增</button>
            </div>
          </form>
        </div>
      `);
    }

    function handleAddStaff(e) {
      e.preventDefault();
      const fd = new FormData(e.target);
      const id = normalize(fd.get('id'));
      if (staff.some(s => s.id === id)) return alert('員工編號重複！');

      staff.push({
        id,
        name: normalize(fd.get('name')),
        title: normalize(fd.get('title')),
        dept: normalize(fd.get('dept')),
        joinDate: normalize(fd.get('joinDate'))
      });

      save();
      closeModal();
    }

    function showStaffDetail(id) {
      const s = staff.find(x => x.id === id);
      if (!s) return;

      openModal(`
        <div class="p-8">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-black">編輯員工資料</h2>
            <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
          </div>

          <form onsubmit="handleUpdateStaff(event, '${escapeHtmlAttr(id)}')" class="space-y-4">
            <div>
              <label class="text-sm font-bold mb-1 block">員工編號</label>
              <input required name="id" value="${escapeHtmlAttr(s.id)}" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
            </div>

            <div>
              <label class="text-sm font-bold mb-1 block">姓名</label>
              <input required name="name" value="${escapeHtmlAttr(s.name)}" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
            </div>

            <div>
              <label class="text-sm font-bold mb-1 block">職稱</label>
              <input name="title" value="${escapeHtmlAttr(s.title || '')}" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
            </div>

            <div>
              <label class="text-sm font-bold mb-1 block">部門</label>
              <input required name="dept" value="${escapeHtmlAttr(s.dept)}" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
            </div>

            <div>
              <label class="text-sm font-bold mb-1 block">到職日期</label>
              <input type="date" required name="joinDate" value="${escapeHtmlAttr(s.joinDate)}" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
            </div>

            <div class="flex gap-3 pt-4">
              <button type="button" onclick="deleteStaff('${escapeHtmlAttr(id)}')"
                      class="px-6 py-4 border border-red-100 text-red-500 rounded-2xl font-bold">刪除</button>
              <button type="submit"
                      class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-bold">儲存變更</button>
            </div>
          </form>
        </div>
      `);
    }

    function handleUpdateStaff(e, oldId) {
      e.preventDefault();
      const fd = new FormData(e.target);

      const index = staff.findIndex(x => x.id === oldId);
      if (index < 0) return;

      const oldName = staff[index].name;
      const newId = normalize(fd.get('id'));
      const newName = normalize(fd.get('name'));
      const newDept = normalize(fd.get('dept'));

      if (newId !== oldId && staff.some(s => s.id === newId)) return alert('員工編號重複！');

      assets.forEach(a => {
        if (a.user === oldName) {
          a.user = newName;
          a.dept = newDept;
        }
      });

      staff[index] = {
        id: newId,
        name: newName,
        title: normalize(fd.get('title')),
        dept: newDept,
        joinDate: normalize(fd.get('joinDate'))
      };

      if (selectedStaffIds.has(oldId)) {
        selectedStaffIds.delete(oldId);
        selectedStaffIds.add(newId);
      }

      save();
      closeModal();
    }

    function deleteStaff(id) {
      if (!confirm('確定刪除此員工？其保管的資產將變為未分配。')) return;
      const s = staff.find(x => x.id === id);
      staff = staff.filter(x => x.id !== id);
      assets.forEach(a => { if (a.user === s.name) { a.user = ''; a.dept = ''; } });
      selectedStaffIds.delete(id);
      save();
      closeModal();
    }

    /*****************************
     * Print: searchable dropdown UI
     *****************************/
    function openPrintModal() {
      openModal(`
        <div class="p-8">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-black">生成領用單</h2>
            <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
          </div>

          <div class="space-y-4">
            <div>
              <label class="text-xs font-bold text-slate-400 mb-2 block">部門（可搜尋）</label>
              <div id="ss-dept"></div>
            </div>

            <div>
              <label class="text-xs font-bold text-slate-400 mb-2 block">員工姓名（可搜尋）</label>
              <div id="ss-staff"></div>
              <p class="text-[11px] text-slate-400 mt-2">
                只列出「名下有設備」的員工，避免生成沒內容。
              </p>
            </div>

            <div class="flex gap-3 pt-2">
              <button type="button" onclick="closeModal()"
                      class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-200">
                取消
              </button>
              <button type="button" onclick="handleGeneratePrintFromSearchSelect()"
                      class="flex-1 py-3 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg shadow-indigo-100">
                生成
              </button>
            </div>
          </div>
        </div>
      `);

      setTimeout(() => {
        initPrintSearchSelects();
        lucide.createIcons();
      }, 0);
    }

    let printSelectedDept = '全部';
    let printSelectedStaffName = '';

    function initPrintSearchSelects() {
      const deptOptions = ['全部', ...Array.from(getDeptSetFromStaff()).sort((a,b)=>a.localeCompare(b,'zh-Hant'))]
        .map(d => ({ value: d, label: d }));

      createSearchableSelect('ss-dept', deptOptions, '全部', (opt) => {
        printSelectedDept = opt.value;
        printSelectedStaffName = '';
        updatePrintStaffSearchSelect();
      });

      updatePrintStaffSearchSelect();
    }

    function updatePrintStaffSearchSelect() {
      const candidates = staff
        .filter(s => {
          const okDept = (printSelectedDept === '全部') ? true : (normalize(s.dept) === printSelectedDept);
          if (!okDept) return false;
          const count = assets.filter(a => a.user === s.name).length;
          return count > 0;
        })
        .sort((a,b)=>normalize(a.name).localeCompare(normalize(b.name),'zh-Hant'))
        .map(s => ({ value: s.name, label: s.name }));

      createSearchableSelect('ss-staff', candidates, '', (opt) => {
        printSelectedStaffName = opt.value;
      }, { placeholder: '搜尋員工姓名…', emptyText: '此部門目前沒有可生成領用單的員工' });
    }

    function handleGeneratePrintFromSearchSelect() {
      if (!printSelectedStaffName) {
        alert('請先選擇員工');
        return;
      }
      closeModal();
      generatePrintByUser(printSelectedStaffName);
    }

    /**
     * createSearchableSelect(containerId, options, defaultValue, onSelect, config)
     * options: [{value,label}]
     */
    function createSearchableSelect(containerId, options, defaultValue, onSelect, config = {}) {
      const container = document.getElementById(containerId);
      if (!container) return;

      const placeholder = config.placeholder || '請搜尋或選擇…';
      const emptyText = config.emptyText || '無符合項目';

      let current = options.find(o => o.value === defaultValue) || null;

      container.innerHTML = `
        <div class="ss-wrap">
          <button type="button" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold flex items-center justify-between gap-2"
                  onclick="toggleSSPanel('${escapeHtmlAttr(containerId)}')">
            <span id="${containerId}-label" class="${current ? 'text-slate-800' : 'text-slate-400'}">
              ${current ? escapeHtml(current.label) : placeholder}
            </span>
            <i data-lucide="chevron-down" class="w-5 h-5 text-slate-400"></i>
          </button>

          <div id="${containerId}-panel" class="ss-panel hidden">
            <div class="p-3 border-b bg-white">
              <div class="relative">
                <i data-lucide="search" class="w-4 h-4 absolute left-3 top-3 text-slate-400"></i>
                <input id="${containerId}-search" type="text"
                       class="w-full pl-10 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-indigo-500"
                       placeholder="${escapeHtmlAttr(placeholder)}"
                       oninput="filterSS('${escapeHtmlAttr(containerId)}')">
              </div>
            </div>
            <div id="${containerId}-list" class="max-h-72 overflow-y-auto custom-scroll p-2 bg-white"></div>
          </div>

          <input type="hidden" id="${containerId}-value" value="${current ? escapeHtmlAttr(current.value) : ''}">
        </div>
      `;

      const list = document.getElementById(`${containerId}-list`);
      list.innerHTML = renderSSList(containerId, options, current?.value, emptyText);

      ssRegistry[containerId] = { options, emptyText, onSelect };

      if (current) onSelect(current);
      lucide.createIcons();
    }

    const ssRegistry = {};

    function toggleSSPanel(containerId) {
      Object.keys(ssRegistry).forEach(id => {
        if (id !== containerId) {
          const p = document.getElementById(`${id}-panel`);
          if (p) p.classList.add('hidden');
        }
      });

      const panel = document.getElementById(`${containerId}-panel`);
      if (!panel) return;
      panel.classList.toggle('hidden');

      if (!panel.classList.contains('hidden')) {
        const input = document.getElementById(`${containerId}-search`);
        input.value = '';
        input.focus();
        filterSS(containerId);
      }
    }

    function filterSS(containerId) {
      const reg = ssRegistry[containerId];
      if (!reg) return;

      const q = (document.getElementById(`${containerId}-search`)?.value || '').toLowerCase();
      const selected = document.getElementById(`${containerId}-value`)?.value || '';

      const options = reg.options.filter(o => o.label.toLowerCase().includes(q));
      const list = document.getElementById(`${containerId}-list`);
      list.innerHTML = renderSSList(containerId, options, selected, reg.emptyText);
      lucide.createIcons();
    }

    function renderSSList(containerId, options, selectedValue, emptyText) {
      if (!options || options.length === 0) {
        return `<div class="p-4 text-sm text-slate-400">${escapeHtml(emptyText)}</div>`;
      }
      return options.map(o => `
        <button type="button"
                class="ss-item w-full text-left px-4 py-3 rounded-xl text-sm font-bold flex items-center justify-between ${o.value===selectedValue ? 'active' : 'text-slate-700'}"
                onclick="selectSS('${escapeHtmlAttr(containerId)}','${escapeHtmlAttr(o.value)}')">
          <span>${escapeHtml(o.label)}</span>
          ${o.value===selectedValue ? '<i data-lucide="check" class="w-4 h-4"></i>' : ''}
        </button>
      `).join('');
    }

    function selectSS(containerId, value) {
      const reg = ssRegistry[containerId];
      if (!reg) return;
      const opt = reg.options.find(o => o.value === value);
      if (!opt) return;

      document.getElementById(`${containerId}-value`).value = opt.value;
      const label = document.getElementById(`${containerId}-label`);
      label.textContent = opt.label;
      label.className = 'text-slate-800';

      document.getElementById(`${containerId}-panel`).classList.add('hidden');
      reg.onSelect(opt);
    }

    document.addEventListener('click', (e) => {
      const isInside = e.target.closest('.ss-wrap');
      if (isInside) return;
      Object.keys(ssRegistry).forEach(id => {
        const p = document.getElementById(`${id}-panel`);
        if (p) p.classList.add('hidden');
      });
    });

/*****************************
 * Print Generate (Sorted by receiveDate desc)
 *****************************/
function generatePrintByUser(userName) {
  userName = normalize(userName);
  if (!userName) {
    alert("該設備尚未分配給任何員工。");
    return;
  }

  const staffObj = staff.find(s => s.name === userName);
  if (!staffObj) {
    alert("找不到員工資料，請先到員工管理建立該員工。");
    return;
  }

  // 該員工名下資產
  const userAssetsRaw = assets.filter(a => a.user === userName);

  if (userAssetsRaw.length === 0) {
    alert("該員工目前名下無任何領用設備。");
    return;
  }

  // ✅ 排序：依領用日期(領取日期)由新到舊
  // receiveDate 支援 "YYYY-MM-DD" / "YYYY/M/D" / "YYYY/MM/DD"
  const toTime = (d) => {
    const s = normalize(d);
    if (!s) return 0;
    // 允許斜線日期
    const fixed = s.replace(/\//g, '-');
    const t = Date.parse(fixed);
    return Number.isFinite(t) ? t : 0;
  };

  const userAssets = [...userAssetsRaw].sort((a, b) => {
    return toTime(b.receiveDate) - toTime(a.receiveDate);
  });

  const html = `
    <div class="preview-paper">
      <div style="text-align: center; margin-bottom: 50px;">
        <h1 style="font-size: 32px; font-weight: 900; margin: 0; letter-spacing: 6px; color: #000;">設備領用單</h1>
      </div>

      <div class="section-title">員工資訊</div>
      <table class="asset-table" style="margin-bottom: 30px;">
        <tr>
          <td style="background:#f8fafc;font-weight:700;width:18%;">姓名</td>
          <td style="width:32%;">${escapeHtml(staffObj.name)}</td>
          <td style="background:#f8fafc;font-weight:700;width:18%;">員工編號</td>
          <td style="width:32%;font-family:monospace;">${escapeHtml(staffObj.id)}</td>
        </tr>
        <tr>
          <td style="background:#f8fafc;font-weight:700;">部門</td>
          <td>${escapeHtml(staffObj.dept || '')}</td>
          <td style="background:#f8fafc;font-weight:700;">職稱</td>
          <td>${escapeHtml(staffObj.title || '')}</td>
        </tr>
        <tr>
          <td style="background:#f8fafc;font-weight:700;">到職日</td>
          <td colspan="3">${escapeHtml(staffObj.joinDate || '')}</td>
        </tr>
      </table>

      <div class="section-title">資產明細 (共 ${userAssets.length} 項)</div>
      <table class="asset-table" style="margin-bottom: 40px;">
        <thead>
          <tr>
            <th style="width: 24%;">資產編號</th>
            <th>設備名稱與規格</th>
            <th style="width: 18%;">領用日期</th>
          </tr>
        </thead>
        <tbody>
          ${userAssets.map(asset => `
            <tr>
              <td style="font-family: monospace; font-weight: 700; font-size: 14px; color: #4338ca; vertical-align: top;">
                ${escapeHtml(asset.id)}
              </td>
              <td>
                <div style="font-weight: 900; font-size: 16px; margin-bottom: 4px;">${escapeHtml(asset.name)}</div>
                <div style="color: #64748b; font-size: 12px;">規格：${escapeHtml(asset.spec || '')}</div>
              </td>
              <td style="vertical-align: top;">
                ${escapeHtml(asset.receiveDate || '')}
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>

      <div style="background:#f1f5f9;padding:25px;border-radius:12px;font-size:14px;line-height:2.2;border:1px solid #e2e8f0;color:#334155;">
        <p style="font-weight: 900; margin-bottom: 12px; font-size: 16px; color: #1e293b;">領用須知事項：</p>
        1. 本表所列設備為公司資產，領用人應善盡保管與合理使用之責。<br>
        2. 設備如有遺失、遭竊或因不當使用致損壞，領用人應依公司指定之維修/採購報價金額負擔賠償責任。<br>
        3. 設備故障請通知Admin，未經核准不得轉借、拆卸或自行維修。<br>
        4. 離職或公司要求時，應立即返還設備及其所有配件（含線材）並完整歸還公司。<br>
      </div>

      <div style="margin-top: 100px; display:flex; gap:60px;">
        <div style="width: 320px;">
          <span style="font-size: 14px; font-weight: 900; color: #1e293b;">領用人簽名/日期：</span>
        </div>
        <div style="width: 320px;">
          <span style="font-size: 14px; font-weight: 900; color: #1e293b;">管理部簽核/日期：</span>
        </div>
      </div>
    </div>
  `;

  document.getElementById('preview-render').innerHTML = html;
  document.getElementById('print-area').innerHTML = html;
  document.getElementById('preview-overlay').classList.remove('hidden');
  lucide.createIcons();
}

    /*****************************
     * CSV Export / Import (✅ 修亂碼：匯出加 BOM；匯入自動判斷編碼)
     *****************************/
    function triggerImport(kind) {
      document.getElementById(kind === 'staff' ? 'import-staff' : 'import-assets').click();
    }

    function exportAssetsCSV() {
      const headers = [
        'id','name','spec','buyDate','receiveDate','warranty','price','user','dept','receipt','warrantyDoc'
      ];
      const rows = assets.map(a => headers.map(h => a[h] ?? ''));
      downloadCSV('assets.csv', headers, rows);
    }

    function exportStaffCSV() {
      const headers = ['id','name','title','dept','joinDate'];
      const rows = staff.map(s => headers.map(h => s[h] ?? ''));
      downloadCSV('staff.csv', headers, rows);
    }

    function downloadCSV(filename, headers, rows) {
      // ✅ Excel 友善：UTF-8 BOM
      const csv = '\uFEFF' + toCSV(headers, rows);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function handleImportCSV(kind, file) {
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const buf = reader.result;
          const text = decodeCSVBuffer(buf); // ✅ 自動判斷
          const { headers, rows } = parseCSV(text);

          if (kind === 'staff') {
            const required = ['id','name','dept'];
            required.forEach(r => { if (!headers.includes(r)) throw new Error(`缺少欄位：${r}`); });

            const imported = rows
              .filter(r => normalize(r[headers.indexOf('id')]))
              .map(r => ({
                id: normalize(r[headers.indexOf('id')]),
                name: normalize(r[headers.indexOf('name')]),
                title: headers.includes('title') ? normalize(r[headers.indexOf('title')]) : '',
                dept: normalize(r[headers.indexOf('dept')]),
                joinDate: headers.includes('joinDate') ? normalize(r[headers.indexOf('joinDate')]) : ''
              }));

            const map = new Map(staff.map(s => [s.id, s]));
            imported.forEach(s => map.set(s.id, s));
            staff = Array.from(map.values());

            save();
            alert(`已匯入員工 ${imported.length} 筆（以員工編號合併更新）`);
          } else {
            const required = ['id','name'];
            required.forEach(r => { if (!headers.includes(r)) throw new Error(`缺少欄位：${r}`); });

            const imported = rows
              .filter(r => normalize(r[headers.indexOf('id')]))
              .map(r => {
                const obj = {};
                headers.forEach((h, idx) => obj[h] = normalize(r[idx] ?? ''));

                obj.id = normalize(obj.id);
                obj.name = normalize(obj.name);

                if (obj.user) {
                  const st = getStaffByName(obj.user);
                  obj.dept = st ? st.dept : (obj.dept || '');
                }

                obj.history = [];
                obj.repairs = [];
                return obj;
              });

            const map = new Map(assets.map(a => [a.id, a]));
            imported.forEach(a => map.set(a.id, a));
            assets = Array.from(map.values());

            // ✅ 匯入後：避免舊勾選殘留
            selectedAssetIds.clear();

            save();
            alert(`已匯入資產 ${imported.length} 筆（以資產編號合併更新）`);
          }

        } catch (err) {
          console.error(err);
          alert(`匯入失敗：${err.message || err}`);
        } finally {
          const input = document.getElementById(kind === 'staff' ? 'import-staff' : 'import-assets');
          input.value = '';
        }
      };

      // ✅ 用 ArrayBuffer 才能判斷 BOM / 編碼
      reader.readAsArrayBuffer(file);
    }

    // ✅ 自動判斷 CSV 編碼（UTF-8/UTF-16/BOM/Big5 fallback）
    function decodeCSVBuffer(buf) {
      const u8 = new Uint8Array(buf);

      // BOM checks
      if (u8.length >= 3 && u8[0] === 0xEF && u8[1] === 0xBB && u8[2] === 0xBF) {
        return new TextDecoder('utf-8').decode(u8.slice(3));
      }
      if (u8.length >= 2 && u8[0] === 0xFF && u8[1] === 0xFE) {
        return new TextDecoder('utf-16le').decode(u8.slice(2));
      }
      if (u8.length >= 2 && u8[0] === 0xFE && u8[1] === 0xFF) {
        return new TextDecoder('utf-16be').decode(u8.slice(2));
      }

      // try utf-8 first
      let t = new TextDecoder('utf-8', { fatal: false }).decode(u8);

      // if many replacement chars, fallback big5
      const replCount = (t.match(/\uFFFD/g) || []).length;
      if (replCount > 0) {
        try {
          const t2 = new TextDecoder('big5', { fatal: false }).decode(u8);
          const replCount2 = (t2.match(/\uFFFD/g) || []).length;
          if (replCount2 < replCount) t = t2;
        } catch (_) {}
      }
      return t;
    }

    function toCSV(headers, rows) {
      const esc = (v) => {
        const s = (v ?? '').toString();
        if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
        return s;
      };
      const lines = [];
      lines.push(headers.map(esc).join(','));
      rows.forEach(r => lines.push(r.map(esc).join(',')));
      return lines.join('\n');
    }

    function parseCSV(text) {
      const rows = [];
      let row = [];
      let cur = '';
      let inQuotes = false;

      for (let i=0; i<text.length; i++) {
        const ch = text[i];

        if (inQuotes) {
          if (ch === '"') {
            const next = text[i+1];
            if (next === '"') { cur += '"'; i++; }
            else { inQuotes = false; }
          } else {
            cur += ch;
          }
        } else {
          if (ch === '"') inQuotes = true;
          else if (ch === ',') { row.push(cur); cur = ''; }
          else if (ch === '\n') { row.push(cur); rows.push(row); row = []; cur = ''; }
          else if (ch === '\r') { /* ignore */ }
          else { cur += ch; }
        }
      }
      row.push(cur);
      rows.push(row);

      while (rows.length && rows[rows.length-1].every(c => normalize(c) === '')) rows.pop();

      const headers = (rows.shift() || []).map(h => normalize(h));
      const dataRows = rows.map(r => {
        const out = [];
        for (let i=0; i<headers.length; i++) out.push(r[i] ?? '');
        return out;
      });
      return { headers, rows: dataRows };
    }

    /*****************************
     * Modal base
     *****************************/
    function openModal(html) {
      document.getElementById('modal-content').innerHTML = html;
      document.getElementById('modal-overlay').classList.remove('hidden');
      lucide.createIcons();
    }
    function closeModal() {
      document.getElementById('modal-overlay').classList.add('hidden');
    }
    function closePreview() {
      document.getElementById('preview-overlay').classList.add('hidden');
    }

    /*****************************
     * Escape helpers
     *****************************/
    function escapeHtml(s) {
      return (s ?? '').toString()
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }
    function escapeHtmlAttr(s) {
      return escapeHtml(s).replace(/`/g,'&#96;');
    }

    /*****************************
     * Init
     *****************************/
    window.onload = () => {
      document.getElementById('assets-item-filter-label').textContent = assetsItemFilter; // ✅ 品項 label
      document.getElementById('staff-dept-filter-label').textContent  = staffDeptFilter;
      render();
    };
  </script>
</body>
</html>
