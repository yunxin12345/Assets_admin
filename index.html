<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>企業資產管理系統 - 進階版</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }

    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

    @media print {
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      body { background: white !important; }
      .preview-paper {
        box-shadow: none !important;
        margin: 0 !important;
        width: 100% !important;
        padding: 15mm !important;
        border: none !important;
      }
    }

    .preview-paper {
      background: white;
      width: 210mm;
      min-height: 297mm;
      padding: 20mm;
      margin: 20px auto;
      box-shadow: 0 20px 50px rgba(0,0,0,0.15);
      color: #1e293b;
      border: 1px solid #e2e8f0;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      font-weight: 800;
      border-bottom: 2px solid #334155;
      padding-bottom: 6px;
      margin-bottom: 16px;
    }

    .asset-table { width: 100%; border-collapse: collapse; }
    .asset-table th { background: #f8fafc; border: 1px solid #cbd5e1; padding: 12px; font-size: 13px; text-align: left; }
    .asset-table td { border: 1px solid #cbd5e1; padding: 12px; font-size: 14px; }

    .sort-header { cursor: pointer; user-select: none; }
    .sort-header:hover { background-color: #f1f5f9; }
  </style>
</head>

<body class="text-slate-900">

  <!-- 頂部導覽 -->
  <nav class="bg-white border-b border-slate-200 sticky top-0 z-40 no-print">
    <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
      <div class="flex items-center gap-6">
        <div class="flex items-center gap-3">
          <div class="bg-indigo-600 p-2 rounded-xl text-white">
            <i data-lucide="shield-check" class="w-5 h-5"></i>
          </div>
          <h1 class="text-xl font-black text-slate-800">資產管理系統</h1>
        </div>

        <div class="flex bg-slate-100 p-1 rounded-xl">
          <button id="tab-assets" class="px-5 py-1.5 rounded-lg text-sm font-bold transition-all bg-white shadow-sm text-indigo-600">資產清冊</button>
          <button id="tab-staff" class="px-5 py-1.5 rounded-lg text-sm font-bold transition-all text-slate-500 hover:text-slate-700">員工管理</button>
        </div>
      </div>

      <div class="flex gap-3">
        <button onclick="openGenerateSlipModal()" class="px-4 py-2 bg-emerald-50 text-emerald-700 border border-emerald-200 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-emerald-100 transition-colors">
          <i data-lucide="file-text" class="w-4 h-4"></i> 生成領用單
        </button>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto p-6 no-print">
    <!-- 資產清冊區域 -->
    <section id="section-assets" class="space-y-4">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <h2 class="text-2xl font-black">資產清冊</h2>

        <div class="flex flex-wrap gap-2 items-center">
          <!-- CSV 匯出/匯入 -->
          <button onclick="exportCSV('assets')" class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-slate-50">
            <i data-lucide="download" class="w-4 h-4 text-slate-600"></i> 匯出
          </button>
          <button onclick="importCSV('assets')" class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-slate-50">
            <i data-lucide="upload" class="w-4 h-4 text-slate-600"></i> 匯入
          </button>
          <span class="text-xs text-slate-400 font-bold">(CSV)</span>

          <div class="w-px h-8 bg-slate-200 mx-1 hidden md:block"></div>

          <div class="relative">
            <i data-lucide="search" class="w-4 h-4 absolute left-3 top-3 text-slate-400"></i>
            <input type="text" id="asset-search" placeholder="搜尋設備名稱或編號..." class="pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-sm w-64 focus:ring-2 focus:ring-indigo-500 outline-none">
          </div>

          <button onclick="showAddAssetModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-sm font-black flex items-center gap-2 shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all">
            <i data-lucide="plus" class="w-4 h-4"></i> 新增資產
          </button>
        </div>
      </div>

      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden overflow-x-auto">
        <table class="w-full text-left">
          <thead class="bg-slate-50 border-b border-slate-200 text-[11px] font-black text-slate-400 uppercase tracking-wider">
            <tr>
              <th class="p-4">資產編號</th>

              <th class="p-4 sort-header group" onclick="toggleSort('name')">
                <div class="flex items-center gap-1">
                  設備名稱
                  <span id="sort-icon-name"><i data-lucide="chevrons-up-down" class="w-3 h-3 text-slate-300"></i></span>

                  <!-- 篩選（加大下拉） -->
                  <div class="relative ml-auto">
                    <button type="button" onclick="event.stopPropagation(); toggleAssetFilterMenu()" class="p-1 hover:bg-slate-200 rounded">
                      <i data-lucide="filter" class="w-3 h-3 text-slate-400 group-hover:text-indigo-500"></i>
                    </button>
                    <div id="asset-filter-menu" class="hidden absolute top-full right-0 mt-2 w-44 bg-white shadow-xl border border-slate-100 rounded-xl p-2 z-50 normal-case">
                      <button onclick="setAssetFilter('all')" class="w-full text-left px-3 py-2 hover:bg-slate-50 text-xs text-slate-700 rounded-lg">全部</button>
                      <button onclick="setAssetFilter('assigned')" class="w-full text-left px-3 py-2 hover:bg-slate-50 text-xs text-slate-700 rounded-lg">已分配</button>
                      <button onclick="setAssetFilter('unassigned')" class="w-full text-left px-3 py-2 hover:bg-slate-50 text-xs text-slate-700 rounded-lg">待分配</button>
                    </div>
                  </div>
                </div>
              </th>

              <th class="p-4">保管人</th>
              <th class="p-4">部門</th>
              <th class="p-4">規格</th>
              <th class="p-4 text-right">操作</th>
            </tr>
          </thead>
          <tbody id="asset-list" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>
    </section>

    <!-- 員工管理區域 -->
    <section id="section-staff" class="hidden space-y-4">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <h2 class="text-2xl font-black">員工管理</h2>

        <div class="flex flex-wrap gap-2 items-center justify-end">
          <!-- CSV 匯出/匯入 -->
          <button onclick="exportCSV('staff')" class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-slate-50">
            <i data-lucide="download" class="w-4 h-4 text-slate-600"></i> 匯出
          </button>
          <button onclick="importCSV('staff')" class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-slate-50">
            <i data-lucide="upload" class="w-4 h-4 text-slate-600"></i> 匯入
          </button>
          <span class="text-xs text-slate-400 font-bold">(CSV)</span>

          <div class="w-px h-8 bg-slate-200 mx-1 hidden md:block"></div>

          <button onclick="bulkDeleteStaff()" class="px-4 py-2 bg-red-50 text-red-600 border border-red-200 rounded-xl text-sm font-black flex items-center gap-2 hover:bg-red-100 transition-colors">
            <i data-lucide="trash-2" class="w-4 h-4"></i> 批次刪除
          </button>

          <button onclick="showAddStaffModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-sm font-black flex items-center gap-2">
            <i data-lucide="user-plus" class="w-4 h-4"></i> 新增員工
          </button>
        </div>
      </div>

      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden overflow-x-auto">
        <table class="w-full text-left">
          <thead class="bg-slate-50 border-b border-slate-200 text-[11px] font-black text-slate-400">
            <tr>
              <th class="p-4 w-10">
                <input id="staff-check-all" type="checkbox" class="w-4 h-4" onclick="toggleAllStaffCheckbox(this.checked)">
              </th>
              <th class="p-4">員工編號</th>
              <th class="p-4">姓名</th>
              <th class="p-4">職稱</th>

              <!-- 部門 + 篩選按鈕 -->
              <th class="p-4">
                <div class="flex items-center gap-2">
                  <span>部門</span>
                  <div class="relative">
                    <button type="button" onclick="toggleStaffDeptFilterMenu()" class="p-1 hover:bg-slate-200 rounded">
                      <i data-lucide="filter" class="w-3.5 h-3.5 text-slate-500"></i>
                    </button>
                    <div id="staff-dept-filter-menu" class="hidden absolute top-full left-0 mt-2 w-56 bg-white shadow-xl border border-slate-100 rounded-xl p-2 z-50 normal-case">
                      <!-- 動態塞入 -->
                    </div>
                  </div>
                </div>
              </th>

              <th class="p-4">到職日期</th>
              <th class="p-4 text-right">管理</th>
            </tr>
          </thead>
          <tbody id="staff-list" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- 共用匯入 input（CSV） -->
  <input id="import-file" type="file" accept=".csv,text/csv" class="hidden"/>

  <!-- Modal 容器 -->
  <div id="modal-overlay" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto custom-scroll" id="modal-content"></div>
  </div>

  <!-- 列印預覽 -->
  <div id="preview-overlay" class="hidden fixed inset-0 bg-slate-900/90 z-[60] overflow-y-auto no-print">
    <div class="sticky top-0 bg-white border-b p-4 flex justify-between items-center shadow-lg">
      <button onclick="closePreview()" class="p-2 hover:bg-slate-100 rounded-full">
        <i data-lucide="x" class="w-6 h-6"></i>
      </button>
      <div class="flex gap-3">
        <button onclick="window.print()" class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-black flex items-center gap-2">
          <i data-lucide="printer" class="w-5 h-5"></i> 確認列印
        </button>
      </div>
    </div>
    <div id="preview-render" class="flex justify-center py-10"></div>
  </div>

  <!-- 真實列印區域 -->
  <div id="print-area" class="hidden print-only"></div>

  <script>
    // =========================
    // LocalStorage Keys
    // =========================
    const KEY_ASSETS = "assets_pro_v4";
    const KEY_STAFF  = "staff_pro_v4";

    // =========================
    // Data Init
    // =========================
    let assets = JSON.parse(localStorage.getItem(KEY_ASSETS)) || [];
    let staff  = JSON.parse(localStorage.getItem(KEY_STAFF))  || [
      { id: "EMP001", name: "王大明", title: "工程師", dept: "技術部", joinDate: "2023-01-01" }
    ];

    let currentSort = { key: null, direction: 'asc' };
    let currentAssetFilter = "all";
    let currentStaffDeptFilter = "ALL"; // ALL / deptName
    let selectedStaffIds = new Set();

    // =========================
    // Helpers
    // =========================
    function saveAll() {
      localStorage.setItem(KEY_ASSETS, JSON.stringify(assets));
      localStorage.setItem(KEY_STAFF, JSON.stringify(staff));
      render();
    }

    function isURL(str) {
      try { const url = new URL(str); return url.protocol === "http:" || url.protocol === "https:"; }
      catch (_) { return false; }
    }
    function openLink(val) { if (isURL(val)) window.open(val, "_blank"); }

    function getStaffByName(name) {
      return staff.find(s => s.name === name);
    }
    function uniqueDepts() {
      const set = new Set(staff.map(s => (s.dept || "").trim()).filter(Boolean));
      return Array.from(set).sort((a,b)=>a.localeCompare(b,'zh-Hant'));
    }

    // =========================
    // Tabs
    // =========================
    document.getElementById('tab-assets').onclick = () => switchTab('assets');
    document.getElementById('tab-staff').onclick  = () => switchTab('staff');
    function switchTab(type) {
      const isAssets = type === 'assets';
      document.getElementById('section-assets').classList.toggle('hidden', !isAssets);
      document.getElementById('section-staff').classList.toggle('hidden', isAssets);
      document.getElementById('tab-assets').className = isAssets
        ? "px-5 py-1.5 rounded-lg text-sm font-bold transition-all bg-white shadow-sm text-indigo-600"
        : "px-5 py-1.5 rounded-lg text-sm font-bold transition-all text-slate-500 hover:text-slate-700";
      document.getElementById('tab-staff').className = !isAssets
        ? "px-5 py-1.5 rounded-lg text-sm font-bold transition-all bg-white shadow-sm text-indigo-600"
        : "px-5 py-1.5 rounded-lg text-sm font-bold transition-all text-slate-500 hover:text-slate-700";
    }

    document.getElementById('asset-search').oninput = render;

    // =========================
    // Assets Filters / Sort
    // =========================
    function toggleSort(key) {
      if (currentSort.key === key) currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      else { currentSort.key = key; currentSort.direction = 'asc'; }
      render();
    }

    function toggleAssetFilterMenu() {
      const menu = document.getElementById('asset-filter-menu');
      menu.classList.toggle('hidden');
    }
    function setAssetFilter(type) {
      currentAssetFilter = type;
      document.getElementById('asset-filter-menu').classList.add('hidden');
      render();
    }

    // =========================
    // Staff Dept Filter
    // =========================
    function toggleStaffDeptFilterMenu() {
      const menu = document.getElementById("staff-dept-filter-menu");
      const isHidden = menu.classList.contains("hidden");
      if (isHidden) buildStaffDeptFilterMenu();
      menu.classList.toggle("hidden");
    }

    function buildStaffDeptFilterMenu() {
      const menu = document.getElementById("staff-dept-filter-menu");
      const depts = uniqueDepts();
      menu.innerHTML = `
        <button onclick="setStaffDeptFilter('ALL')" class="w-full text-left px-3 py-2 hover:bg-slate-50 text-xs text-slate-700 rounded-lg ${currentStaffDeptFilter==='ALL'?'bg-slate-50':''}">
          全部部門
        </button>
        <div class="my-2 border-t border-slate-100"></div>
        ${depts.length ? depts.map(d => `
          <button onclick="setStaffDeptFilter('${escapeHtml(d)}')" class="w-full text-left px-3 py-2 hover:bg-slate-50 text-xs text-slate-700 rounded-lg ${currentStaffDeptFilter===d?'bg-slate-50':''}">
            ${escapeHtml(d)}
          </button>
        `).join("") : `<p class="text-xs text-slate-400 px-3 py-2">尚無部門資料</p>`}
      `;
      lucide.createIcons();
    }

    function setStaffDeptFilter(dept) {
      currentStaffDeptFilter = dept;
      document.getElementById("staff-dept-filter-menu").classList.add("hidden");
      render();
    }

    function escapeHtml(s) {
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    // =========================
    // Render
    // =========================
    function render() {
      // ------- Assets render -------
      const searchTerm = document.getElementById('asset-search').value.toLowerCase();

      let filteredAssets = assets.filter(a => {
        const matchSearch =
          (a.name || "").toLowerCase().includes(searchTerm) ||
          (a.id || "").toLowerCase().includes(searchTerm);

        if (!matchSearch) return false;
        if (currentAssetFilter === 'assigned') return !!a.user;
        if (currentAssetFilter === 'unassigned') return !a.user;
        return true;
      });

      if (currentSort.key) {
        filteredAssets.sort((a, b) => {
          const valA = (a[currentSort.key] || '');
          const valB = (b[currentSort.key] || '');
          return currentSort.direction === 'asc'
            ? valA.localeCompare(valB, 'zh-Hant')
            : valB.localeCompare(valA, 'zh-Hant');
        });
      }

      const sortIcon = document.getElementById('sort-icon-name');
      if (currentSort.key === 'name') {
        sortIcon.innerHTML = currentSort.direction === 'asc'
          ? '<i data-lucide="chevron-up" class="w-3 h-3 text-indigo-600"></i>'
          : '<i data-lucide="chevron-down" class="w-3 h-3 text-indigo-600"></i>';
      } else {
        sortIcon.innerHTML = '<i data-lucide="chevrons-up-down" class="w-3 h-3 text-slate-300"></i>';
      }

      const assetList = document.getElementById('asset-list');
      assetList.innerHTML = filteredAssets.map(a => `
        <tr class="hover:bg-slate-50 cursor-pointer transition-colors" onclick="showAssetDetail('${escapeHtml(a.id)}')">
          <td class="p-4 font-mono text-xs font-bold text-indigo-600">${escapeHtml(a.id)}</td>
          <td class="p-4 font-bold text-slate-700">${escapeHtml(a.name)}</td>
          <td class="p-4">${a.user ? escapeHtml(a.user) : '<span class="text-slate-300">未分配</span>'}</td>
          <td class="p-4 text-slate-500 text-sm">${a.dept ? escapeHtml(a.dept) : '--'}</td>
          <td class="p-4 text-slate-500 text-sm truncate max-w-[220px]">${escapeHtml(a.spec || '')}</td>
          <td class="p-4 text-right">
            <button onclick="event.stopPropagation(); openGenerateSlipModal('${escapeHtml(a.user || '')}')" class="text-indigo-600 hover:text-indigo-800 text-sm font-bold bg-indigo-50 px-3 py-1 rounded-lg">
              領用單
            </button>
          </td>
        </tr>
      `).join('');

      // ------- Staff render -------
      let filteredStaff = [...staff];
      if (currentStaffDeptFilter !== "ALL") {
        filteredStaff = filteredStaff.filter(s => (s.dept || "") === currentStaffDeptFilter);
      }

      // 清掉 check-all 狀態（避免不同篩選造成錯覺）
      const checkAll = document.getElementById("staff-check-all");
      if (checkAll) checkAll.checked = false;

      const staffList = document.getElementById('staff-list');
      staffList.innerHTML = filteredStaff.map(s => `
        <tr class="hover:bg-slate-50 cursor-pointer" onclick="showStaffDetail('${escapeHtml(s.id)}')">
          <td class="p-4 w-10" onclick="event.stopPropagation();">
            <input type="checkbox" class="w-4 h-4" ${selectedStaffIds.has(s.id) ? "checked" : ""} onclick="toggleStaffSelected('${escapeHtml(s.id)}', this.checked)">
          </td>
          <td class="p-4 font-mono text-xs font-bold">${escapeHtml(s.id)}</td>
          <td class="p-4 font-black">${escapeHtml(s.name)}</td>
          <td class="p-4 text-slate-700 font-bold">${escapeHtml(s.title || '')}</td>
          <td class="p-4">${escapeHtml(s.dept || '')}</td>
          <td class="p-4 text-slate-500">${escapeHtml(s.joinDate || '')}</td>
          <td class="p-4 text-right" onclick="event.stopPropagation();">
            <button onclick="showStaffDetail('${escapeHtml(s.id)}')" class="text-slate-400 hover:text-indigo-600">
              <i data-lucide="edit-3" class="w-4 h-4"></i>
            </button>
          </td>
        </tr>
      `).join('');

      lucide.createIcons();
    }

    // =========================
    // Staff bulk select / delete
    // =========================
    function toggleStaffSelected(id, checked) {
      if (checked) selectedStaffIds.add(id);
      else selectedStaffIds.delete(id);
    }
    function toggleAllStaffCheckbox(checked) {
      const visible = [...staff].filter(s => currentStaffDeptFilter === "ALL" ? true : (s.dept||"") === currentStaffDeptFilter);
      visible.forEach(s => checked ? selectedStaffIds.add(s.id) : selectedStaffIds.delete(s.id));
      render();
    }
    function bulkDeleteStaff() {
      if (!selectedStaffIds.size) return alert("請先勾選要刪除的員工。");
      if (!confirm(`確定刪除已勾選的 ${selectedStaffIds.size} 位員工？\n其名下資產將變為未分配。`)) return;

      const toDelete = new Set(selectedStaffIds);
      const deletedNames = staff.filter(s => toDelete.has(s.id)).map(s => s.name);

      staff = staff.filter(s => !toDelete.has(s.id));

      // 資產解除分配（若使用者姓名在刪除名單內）
      assets = assets.map(a => {
        if (deletedNames.includes(a.user)) return { ...a, user: "", dept: "" };
        return a;
      });

      selectedStaffIds.clear();
      saveAll();
    }

    // =========================
    // Asset ID generator
    // =========================
    function generateAssetID(name) {
      const isApple = /apple|mac|iphone|ipad|ipod/i.test(name);
      if (isApple) return "";
      const prefix = (name || "").substring(0, 2).toUpperCase();
      const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, "");
      const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
      return `${prefix}-${dateStr}-${random}`;
    }

    // =========================
    // Modal helpers (all have close X)
    // =========================
    function openModal(innerHTML) {
      document.getElementById('modal-content').innerHTML = innerHTML;
      document.getElementById('modal-overlay').classList.remove('hidden');
      lucide.createIcons();
    }
    function closeModal() {
      document.getElementById('modal-overlay').classList.add('hidden');
      // 關掉篩選選單
      const aMenu = document.getElementById('asset-filter-menu');
      if (aMenu) aMenu.classList.add('hidden');
      const sMenu = document.getElementById('staff-dept-filter-menu');
      if (sMenu) sMenu.classList.add('hidden');
    }
    function closePreview() { document.getElementById('preview-overlay').classList.add('hidden'); }

    // =========================
    // Assets CRUD
    // =========================
    function showAddAssetModal() {
      openModal(`
        <div class="p-8">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-black">新增資產設備</h2>
            <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
          </div>

          <form onsubmit="handleAddAsset(event)" class="space-y-4">
            <div>
              <label class="text-sm font-bold mb-1 block">設備名稱</label>
              <input required name="name" id="new-asset-name" oninput="handleIDPreview(this.value)" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-indigo-500">
            </div>

            <div id="id-container">
              <label class="text-sm font-bold mb-1 block">資產編號</label>
              <input required name="id" id="new-asset-id" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-indigo-500">
            </div>

            <div>
              <label class="text-sm font-bold mb-1 block">規格描述</label>
              <input name="spec" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-indigo-500">
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-sm font-bold mb-1 block">購買日期</label>
                <input type="date" name="buyDate" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
              </div>
              <div>
                <label class="text-sm font-bold mb-1 block">保固日期</label>
                <input type="date" name="warranty" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
              </div>
              <div>
                <label class="text-sm font-bold mb-1 block">購買金額</label>
                <input type="number" name="price" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
              </div>

              <!-- 保管人：員工姓名 -->
              <div>
                <label class="text-sm font-bold mb-1 block">保管人（員工）</label>
                <select name="user" id="new-asset-user" onchange="syncDeptByUser('new-asset-user','new-asset-dept')" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
                  <option value="">-- 未分配 --</option>
                  ${staff.map(s => `<option value="${escapeHtml(s.name)}">${escapeHtml(s.name)}（${escapeHtml(s.id)} / ${escapeHtml(s.dept||'')} / ${escapeHtml(s.title||'')}）</option>`).join('')}
                </select>
              </div>

              <!-- 部門：連動帶出 -->
              <div class="col-span-2">
                <label class="text-sm font-bold mb-1 block">部門（選擇保管人自動帶出）</label>
                <input name="dept" id="new-asset-dept" readonly class="w-full p-3 bg-slate-100 border border-slate-200 rounded-xl text-slate-500" placeholder="--">
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-sm font-bold mb-1 block">收據明細 / 網址</label>
                <textarea name="receipt" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl h-20 text-sm" placeholder="輸入文字或 URL"></textarea>
              </div>
              <div>
                <label class="text-sm font-bold mb-1 block">保固書說明 / 網址</label>
                <textarea name="warrantyDoc" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl h-20 text-sm" placeholder="輸入文字或 URL"></textarea>
              </div>
            </div>

            <div class="flex gap-3 pt-6">
              <button type="button" onclick="closeModal()" class="flex-1 py-4 bg-slate-100 text-slate-500 rounded-2xl font-bold">取消</button>
              <button type="submit" class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg shadow-indigo-100">確認新增</button>
            </div>
          </form>
        </div>
      `);
    }

    function handleIDPreview(val) {
      const idInput = document.getElementById('new-asset-id');
      const generated = generateAssetID(val);
      if (generated) {
        idInput.value = generated;
        idInput.classList.add('bg-slate-100');
      } else {
        idInput.value = "";
        idInput.classList.remove('bg-slate-100');
        idInput.placeholder = "請手動輸入 Apple 資產編號";
      }
    }

    function syncDeptByUser(userSelectId, deptInputId) {
      const sel = document.getElementById(userSelectId);
      const dept = document.getElementById(deptInputId);
      const name = sel?.value || "";
      if (!name) { dept.value = ""; return; }
      const st = getStaffByName(name);
      dept.value = st ? (st.dept || "") : "";
    }

    function handleAddAsset(e) {
      e.preventDefault();
      const fd = new FormData(e.target);
      const id = fd.get('id');

      if (assets.some(a => a.id === id)) return alert('資產編號重複！');

      const userName = fd.get('user') || "";
      const st = getStaffByName(userName);

      assets.push({
        id: id,
        name: fd.get('name'),
        spec: fd.get('spec') || "",
        buyDate: fd.get('buyDate') || "",
        warranty: fd.get('warranty') || "",
        price: fd.get('price') || "",
        user: userName,
        dept: st ? (st.dept || "") : (fd.get('dept') || ""),
        receipt: fd.get('receipt') || "",
        warrantyDoc: fd.get('warrantyDoc') || "",
        history: [],
        repairs: []
      });

      saveAll();
      closeModal();
    }

    function showAssetDetail(id) {
      const a = assets.find(x => x.id === id);
      if (!a) return;

      openModal(`
        <div class="p-8">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-black">資產詳細資訊 / 編輯</h2>
            <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
          </div>

          <form onsubmit="handleUpdateAsset(event, '${escapeHtml(id)}')" class="space-y-6">
            <div class="grid grid-cols-2 gap-4">
              <div class="col-span-2 md:col-span-1">
                <label class="text-xs font-bold text-slate-400 mb-1 block">設備名稱</label>
                <input name="name" value="${escapeHtml(a.name)}" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold">
              </div>
              <div class="col-span-2 md:col-span-1">
                <label class="text-xs font-bold text-slate-400 mb-1 block">資產編號 (唯讀)</label>
                <input disabled value="${escapeHtml(a.id)}" class="w-full p-3 bg-slate-100 border border-slate-200 rounded-xl font-mono text-indigo-600">
              </div>
            </div>

            <div>
              <label class="text-xs font-bold text-slate-400 mb-1 block">規格描述</label>
              <input name="spec" value="${escapeHtml(a.spec||'')}" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-xs font-bold text-slate-400 mb-1 block">保管人（員工姓名）</label>
                <select name="user" id="edit-asset-user" onchange="syncDeptByUser('edit-asset-user','edit-asset-dept')" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
                  <option value="">-- 未分配 --</option>
                  ${staff.map(s => `<option value="${escapeHtml(s.name)}" ${a.user===s.name?'selected':''}>${escapeHtml(s.name)}（${escapeHtml(s.id)} / ${escapeHtml(s.dept||'')} / ${escapeHtml(s.title||'')}）</option>`).join('')}
                </select>
              </div>

              <div>
                <label class="text-xs font-bold text-slate-400 mb-1 block">部門（自動帶出）</label>
                <input name="dept" id="edit-asset-dept" readonly value="${escapeHtml(a.dept||'')}" class="w-full p-3 bg-slate-100 border border-slate-200 rounded-xl text-slate-500">
              </div>

              <div>
                <label class="text-xs font-bold text-slate-400 mb-1 block">購買日期</label>
                <input type="date" name="buyDate" value="${escapeHtml(a.buyDate||'')}" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
              </div>
              <div>
                <label class="text-xs font-bold text-slate-400 mb-1 block">購買金額</label>
                <input type="number" name="price" value="${escapeHtml(a.price||'')}" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
              </div>
              <div>
                <label class="text-xs font-bold text-slate-400 mb-1 block">保固期至</label>
                <input type="date" name="warranty" value="${escapeHtml(a.warranty||'')}" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <div class="flex justify-between items-center mb-1">
                  <label class="text-xs font-bold text-slate-400">收據明細 / 雲端連結</label>
                  ${isURL(a.receipt) ? `<button type="button" onclick="openLink('${escapeHtml(a.receipt)}')" class="text-[10px] text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-md flex items-center gap-1">開啟連結 <i data-lucide="external-link" class="w-2.5 h-2.5"></i></button>` : ''}
                </div>
                <textarea name="receipt" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl h-20 text-sm" placeholder="請輸入收據資訊或網址...">${escapeHtml(a.receipt || '')}</textarea>
              </div>
              <div>
                <div class="flex justify-between items-center mb-1">
                  <label class="text-xs font-bold text-slate-400">保固書說明 / 雲端連結</label>
                  ${isURL(a.warrantyDoc) ? `<button type="button" onclick="openLink('${escapeHtml(a.warrantyDoc)}')" class="text-[10px] text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-md flex items-center gap-1">開啟連結 <i data-lucide="external-link" class="w-2.5 h-2.5"></i></button>` : ''}
                </div>
                <textarea name="warrantyDoc" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl h-20 text-sm" placeholder="請輸入保固資訊或網址...">${escapeHtml(a.warrantyDoc || '')}</textarea>
              </div>
            </div>

            <div class="flex gap-3 pt-6">
              <button type="button" onclick="deleteAsset('${escapeHtml(id)}')" class="px-6 py-3 border border-red-100 text-red-500 rounded-xl font-bold hover:bg-red-50">刪除資產</button>
              <button type="submit" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-100">儲存變更</button>
            </div>
          </form>
        </div>
      `);
    }

    function handleUpdateAsset(e, id) {
      e.preventDefault();
      const fd = new FormData(e.target);
      const index = assets.findIndex(x => x.id === id);
      if (index < 0) return;

      const asset = assets[index];
      const newUser = fd.get('user') || "";

      // 變更使用者 -> 記錄歷史
      if (newUser !== asset.user && asset.user) {
        if (!asset.history) asset.history = [];
        asset.history.unshift({ name: asset.user, date: new Date().toLocaleDateString() });
      }

      const st = getStaffByName(newUser);

      assets[index] = {
        ...asset,
        name: fd.get('name'),
        spec: fd.get('spec'),
        user: newUser,
        dept: st ? (st.dept || "") : (fd.get('dept') || ""),
        buyDate: fd.get('buyDate'),
        price: fd.get('price'),
        warranty: fd.get('warranty'),
        receipt: fd.get('receipt'),
        warrantyDoc: fd.get('warrantyDoc')
      };

      saveAll();
      closeModal();
    }

    function deleteAsset(id) {
      if(!confirm('確定刪除此資產？')) return;
      assets = assets.filter(a => a.id !== id);
      saveAll();
      closeModal();
    }

    // =========================
    // Staff CRUD (add title field)
    // =========================
    function showAddStaffModal() {
      openModal(`
        <div class="p-8">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-black">新增員工</h2>
            <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
          </div>

          <form onsubmit="handleAddStaff(event)" class="space-y-4">
            <div>
              <label class="text-sm font-bold mb-1 block">員工編號</label>
              <input required name="id" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
            </div>
            <div>
              <label class="text-sm font-bold mb-1 block">姓名</label>
              <input required name="name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
            </div>
            <div>
              <label class="text-sm font-bold mb-1 block">職稱</label>
              <input name="title" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl" placeholder="例：工程師 / 行政 / PM">
            </div>
            <div>
              <label class="text-sm font-bold mb-1 block">部門</label>
              <input required name="dept" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
            </div>
            <div>
              <label class="text-sm font-bold mb-1 block">到職日期</label>
              <input type="date" required name="joinDate" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
            </div>

            <div class="flex gap-3 pt-6">
              <button type="button" onclick="closeModal()" class="flex-1 py-4 bg-slate-100 text-slate-500 rounded-2xl font-bold">取消</button>
              <button type="submit" class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-bold">確認新增</button>
            </div>
          </form>
        </div>
      `);
    }

    function handleAddStaff(e) {
      e.preventDefault();
      const fd = new FormData(e.target);
      const id = fd.get("id");

      if (staff.some(s => s.id === id)) return alert("員工編號重複！");

      staff.push({
        id: fd.get('id'),
        name: fd.get('name'),
        title: fd.get('title') || "",
        dept: fd.get('dept'),
        joinDate: fd.get('joinDate')
      });

      // 同步：若資產 user 對應到此姓名（通常不會是新增時）可忽略
      saveAll();
      closeModal();
    }

    function showStaffDetail(id) {
      const s = staff.find(x => x.id === id);
      if (!s) return;

      openModal(`
        <div class="p-8">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-black">編輯員工資料</h2>
            <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
          </div>

          <form onsubmit="handleUpdateStaff(event, '${escapeHtml(id)}')" class="space-y-4">
            <div>
              <label class="text-sm font-bold mb-1 block">員工編號</label>
              <input required name="id" value="${escapeHtml(s.id)}" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
            </div>
            <div>
              <label class="text-sm font-bold mb-1 block">姓名</label>
              <input required name="name" value="${escapeHtml(s.name)}" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
            </div>
            <div>
              <label class="text-sm font-bold mb-1 block">職稱</label>
              <input name="title" value="${escapeHtml(s.title||'')}" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
            </div>
            <div>
              <label class="text-sm font-bold mb-1 block">部門</label>
              <input required name="dept" value="${escapeHtml(s.dept||'')}" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
            </div>
            <div>
              <label class="text-sm font-bold mb-1 block">到職日期</label>
              <input type="date" required name="joinDate" value="${escapeHtml(s.joinDate||'')}" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
            </div>

            <div class="flex gap-3 pt-6">
              <button type="button" onclick="deleteStaff('${escapeHtml(id)}')" class="px-6 py-4 border border-red-100 text-red-500 rounded-2xl font-bold">刪除</button>
              <button type="submit" class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-bold">儲存變更</button>
            </div>
          </form>
        </div>
      `);
    }

    function handleUpdateStaff(e, oldId) {
      e.preventDefault();
      const fd = new FormData(e.target);
      const index = staff.findIndex(x => x.id === oldId);
      if (index < 0) return;

      const oldName = staff[index].name;
      const newId   = fd.get('id');
      const newName = fd.get('name');
      const newDept = fd.get('dept');
      const newTitle= fd.get('title') || "";

      // 若改了員工編號且撞到別人
      if (newId !== oldId && staff.some(s => s.id === newId)) return alert("員工編號重複！");

      // 資產表：若 user = oldName -> 改成 newName，且部門同步
      assets = assets.map(a => {
        if (a.user === oldName) {
          return { ...a, user: newName, dept: newDept || "" };
        }
        return a;
      });

      staff[index] = {
        id: newId,
        name: newName,
        title: newTitle,
        dept: newDept,
        joinDate: fd.get('joinDate')
      };

      // 更新 selectedStaffIds 中的 id（若被勾選）
      if (selectedStaffIds.has(oldId)) {
        selectedStaffIds.delete(oldId);
        selectedStaffIds.add(newId);
      }

      saveAll();
      closeModal();
    }

    function deleteStaff(id) {
      if(!confirm('確定刪除此員工？其保管的資產將變為未分配。')) return;

      const s = staff.find(x => x.id === id);
      staff = staff.filter(x => x.id !== id);
      selectedStaffIds.delete(id);

      assets = assets.map(a => {
        if (a.user === (s?.name || "")) return { ...a, user: "", dept: "" };
        return a;
      });

      saveAll();
      closeModal();
    }

    // =========================
    // Generate Slip (dropdown staff)
    // =========================
    function openGenerateSlipModal(preselectUserName = "") {
      const options = staff
        .slice()
        .sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant'))
        .map(s => {
          const count = assets.filter(a => a.user === s.name).length;
          const label = `${s.name}（${s.id} / ${s.dept || ''} / ${s.title || ''}｜${count}項設備）`;
          return `<option value="${escapeHtml(s.name)}" ${preselectUserName===s.name?'selected':''}>${escapeHtml(label)}</option>`;
        }).join("");

      openModal(`
        <div class="p-8">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-black">生成領用單</h2>
            <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
          </div>

          <div class="space-y-4">
            <div>
              <label class="text-sm font-bold mb-2 block">選擇領用員工</label>
              <select id="slip-staff-select" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
                <option value="">-- 請選擇 --</option>
                ${options}
              </select>
            </div>

            <div class="flex gap-3 pt-2">
              <button onclick="closeModal()" class="flex-1 py-3 bg-slate-100 text-slate-500 rounded-xl font-bold">取消</button>
              <button onclick="handleGenerateSlipFromSelect()" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold">生成</button>
            </div>

            <p class="text-xs text-slate-400 leading-relaxed">
              提醒：只會生成「該員工名下」目前已分配的設備清單。
            </p>
          </div>
        </div>
      `);
    }

    function handleGenerateSlipFromSelect() {
      const sel = document.getElementById("slip-staff-select");
      const name = sel?.value || "";
      if (!name) return alert("請先選擇員工。");
      closeModal();
      generatePrintByUser(name);
    }

    function generatePrintByUser(userName) {
      if (!userName || userName === "null" || userName === "undefined") {
        alert("請先選擇員工。");
        return;
      }
      const staffObj = staff.find(s => s.name === userName);
      const userAssets = assets.filter(a => a.user === userName);

      if (!staffObj) {
        alert("找不到該員工資料。");
        return;
      }
      if (userAssets.length === 0) {
        alert("該員工目前名下無任何領用設備。");
        return;
      }

      const html = `
        <div class="preview-paper">
          <div style="text-align: center; margin-bottom: 50px;">
            <h1 style="font-size: 32px; font-weight: 900; margin: 0; letter-spacing: 6px; color: #000;">設備領用單</h1>
          </div>

          <div class="section-title">員工資訊</div>
          <table class="asset-table" style="margin-bottom: 30px;">
            <tr>
              <td style="background: #f8fafc; font-weight: 700; width: 18%;">姓名</td>
              <td style="width: 32%;">${escapeHtml(staffObj.name)}</td>
              <td style="background: #f8fafc; font-weight: 700; width: 18%;">員工編號</td>
              <td style="width: 32%; font-family: monospace;">${escapeHtml(staffObj.id)}</td>
            </tr>
            <tr>
              <td style="background: #f8fafc; font-weight: 700;">部門</td>
              <td>${escapeHtml(staffObj.dept || '')}</td>
              <td style="background: #f8fafc; font-weight: 700;">職稱</td>
              <td>${escapeHtml(staffObj.title || '')}</td>
            </tr>
            <tr>
              <td style="background: #f8fafc; font-weight: 700;">到職日</td>
              <td colspan="3">${escapeHtml(staffObj.joinDate || '')}</td>
            </tr>
          </table>

          <div class="section-title">資產明細 (共 ${userAssets.length} 項)</div>
          <table class="asset-table" style="margin-bottom: 40px;">
            <thead>
              <tr>
                <th style="width: 30%;">資產編號</th>
                <th>設備名稱與規格</th>
              </tr>
            </thead>
            <tbody>
              ${userAssets.map(asset => `
                <tr>
                  <td style="font-family: monospace; font-weight: 700; font-size: 14px; color: #4338ca; vertical-align: top;">
                    ${escapeHtml(asset.id)}
                  </td>
                  <td>
                    <div style="font-weight: 900; font-size: 16px; margin-bottom: 4px;">
                      ${escapeHtml(asset.name)}
                    </div>
                    <div style="color: #64748b; font-size: 12px;">
                      規格：${escapeHtml(asset.spec || '')}
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>

          <div style="background: #f1f5f9; padding: 25px; border-radius: 12px; font-size: 14px; line-height: 2.2; border: 1px solid #e2e8f0; color: #334155;">
            <p style="font-weight: 900; margin-bottom: 12px; font-size: 16px; color: #1e293b;">領用須知事項：</p>
            1. 本設備為公司資產，僅供公務使用，領用人應善盡保管與合理使用義務。<br>
            2. 如有遺失、遭竊、人為損毀或不當使用致設備損壞，領用人同意依公司指定維修/更換之報價金額負擔賠償責任。<br>
            3. 設備故障請通知Admin並依流程報修，未經核准不得轉借他人或自行拆卸/維修。<br>
            4. 離職或調職時，須依本清單逐項歸還設備及配件並完成清點結清。
          </div>

          <div style="margin-top: 100px; display: flex; justify-content: flex-start;">
            <div style="width: 320px;">
              <span style="font-size: 14px; font-weight: 900; color: #1e293b;">領用人簽名/日期：</span>
            </div>
          </div>
        </div>
      `;

      document.getElementById('preview-render').innerHTML = html;
      document.getElementById('print-area').innerHTML = html;
      document.getElementById('preview-overlay').classList.remove('hidden');
      lucide.createIcons();
    }

    // =========================
    // CSV Import / Export (Assets / Staff)
    // =========================
    const CSV_SCHEMA = {
      assets: ["id","name","spec","user","dept","buyDate","warranty","price","receipt","warrantyDoc"],
      staff:  ["id","name","title","dept","joinDate"]
    };
    const CSV_HEADER_LABELS = {
      assets: { id:"資產編號", name:"設備名稱", spec:"規格", user:"保管人", dept:"部門", buyDate:"購買日期", warranty:"保固日期", price:"購買金額", receipt:"收據明細/網址", warrantyDoc:"保固書/網址" },
      staff:  { id:"員工編號", name:"姓名", title:"職稱", dept:"部門", joinDate:"到職日期" }
    };
    const CSV_HEADER_ALIASES = {
      "資產編號":"id","設備名稱":"name","規格":"spec","保管人":"user","部門":"dept","購買日期":"buyDate","保固日期":"warranty","購買金額":"price","收據明細/網址":"receipt","保固書/網址":"warrantyDoc",
      "員工編號":"id","姓名":"name","職稱":"title","到職日期":"joinDate"
    };

    function toCSV(rows, keys, headerLabelsMap) {
      const headerLabels = keys.map(k => headerLabelsMap?.[k] ?? k);
      const escapeCell = (v) => {
        const s = String(v ?? "");
        if (/[,"\r\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
        return s;
      };
      const lines = [];
      lines.push(headerLabels.map(escapeCell).join(","));
      for (const row of rows) lines.push(keys.map(k => escapeCell(row?.[k])).join(","));
      return "\ufeff" + lines.join("\r\n"); // BOM for Excel
    }

    function parseCSV(text) {
      const rows = [];
      let row = [];
      let cell = "";
      let inQuotes = false;

      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

      const pushCell = () => { row.push(cell); cell = ""; };
      const pushRow  = () => { rows.push(row); row = []; };

      for (let i=0;i<text.length;i++) {
        const ch = text[i];
        const next = text[i+1];

        if (inQuotes) {
          if (ch === '"' && next === '"') { cell += '"'; i++; }
          else if (ch === '"') inQuotes = false;
          else cell += ch;
          continue;
        }

        if (ch === '"') { inQuotes = true; continue; }
        if (ch === ",") { pushCell(); continue; }
        if (ch === "\r" && next === "\n") { pushCell(); pushRow(); i++; continue; }
        if (ch === "\n") { pushCell(); pushRow(); continue; }
        cell += ch;
      }
      pushCell();
      if (row.length > 1 || (row.length === 1 && row[0] !== "")) pushRow();
      if (!rows.length) return { headers: [], rows: [] };
      return { headers: rows[0].map(h => String(h||"").trim()), rows: rows.slice(1) };
    }

    function normalizeHeaderKey(h) {
      const key = String(h || "").trim();
      return CSV_HEADER_ALIASES[key] || key;
    }

    function downloadFile(filename, content, mime) {
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportCSV(type) {
      const data = type === "assets" ? assets : staff;
      const keys = CSV_SCHEMA[type];
      const csv  = toCSV(data, keys, CSV_HEADER_LABELS[type]);
      const filename = type === "assets" ? "assets.csv" : "staff.csv";
      downloadFile(filename, csv, "text/csv;charset=utf-8");
    }

    function importCSV(type) {
      const input = document.getElementById("import-file");
      input.value = "";

      input.onchange = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        try {
          const text = await file.text();
          const { headers, rows } = parseCSV(text);
          if (!headers.length) return alert("匯入失敗：CSV 沒有表頭。");

          const headerKeys = headers.map(normalizeHeaderKey);
          const objs = rows
            .filter(r => r.some(x => String(x ?? "").trim() !== ""))
            .map(r => {
              const obj = {};
              headerKeys.forEach((k, idx) => obj[k] = (r[idx] ?? "").trim());
              return obj;
            });

          if (type === "staff") {
            const ok = objs.every(x => x.id && x.name);
            if (!ok) return alert("員工 CSV 欄位不足：至少需要「員工編號」「姓名」。");

            staff = objs.map(s => ({
              id: s.id,
              name: s.name,
              title: s.title || "",
              dept: s.dept || "",
              joinDate: s.joinDate || ""
            }));

            // 匯入員工後：同步 assets 部門（以保管人姓名）
            assets = assets.map(a => {
              if (!a.user) return a;
              const st = getStaffByName(a.user);
              return st ? { ...a, dept: st.dept || "" } : a;
            });

            saveAll();
            alert("員工匯入完成 ✅");
            return;
          }

          // assets
          const ok = objs.every(x => x.id && x.name);
          if (!ok) return alert("資產 CSV 欄位不足：至少需要「資產編號」「設備名稱」。");

          assets = objs.map(a => {
            const userName = a.user || "";
            const st = getStaffByName(userName);
            return {
              id: a.id,
              name: a.name,
              spec: a.spec || "",
              user: userName,
              dept: st ? (st.dept || "") : (a.dept || ""),
              buyDate: a.buyDate || "",
              warranty: a.warranty || "",
              price: a.price || "",
              receipt: a.receipt || "",
              warrantyDoc: a.warrantyDoc || "",
              history: [],
              repairs: []
            };
          });

          saveAll();
          alert("資產匯入完成 ✅");
        } catch (err) {
          console.error(err);
          alert("匯入失敗：CSV 解析錯誤或格式不正確。");
        }
      };

      input.click();
    }

    // =========================
    // Init
    // =========================
    window.onload = () => {
      render();
      // 點空白處關閉篩選選單
      document.addEventListener("click", (e) => {
        const aMenu = document.getElementById("asset-filter-menu");
        const sMenu = document.getElementById("staff-dept-filter-menu");
        if (aMenu && !aMenu.contains(e.target)) aMenu.classList.add("hidden");
        if (sMenu && !sMenu.contains(e.target)) sMenu.classList.add("hidden");
      });
    };
  </script>
</body>
</html>

